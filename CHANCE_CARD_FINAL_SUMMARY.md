# 찬스 카드 검증 최종 요약

## 📊 전체 현황

### 총 26장의 찬스 카드

| 카테고리 | 카드 수 | 구현 상태 | 비고 |
|---------|---------|----------|------|
| 돈 카드 | 7장 | ✅ 완전 구현 | CH1-CH7 |
| 상호작용 카드 | 6장 | ✅ 완전 구현 | CH8-CH13 (CH11-13은 2인 금지) |
| 드로우 카드 | 3장 | ✅ 완전 구현 | CH14-CH16 |
| 특수 행동 카드 | 4장 | ⚠️ 부분 구현 | CH17-CH20 (CH17-19 프론트엔드 필요) |
| 캐치업 카드 | 5장 | ⚠️ 부분 구현 | CH21-CH25 (CH25 프론트엔드 필요) |

**완전 구현**: 21장 (80.8%)  
**부분 구현**: 5장 (19.2%) - 프론트엔드 추가 작업 필요

---

## ✅ 완전 구현된 카드 (21장)

### 1. 돈 카드 (7장)
- **CH1**: 아빠가 기분 좋아서! (+3,000TC)
- **CH2**: 여행 지원금 당첨! (+4,000TC)
- **CH3**: 준비물 구매 (-1,000TC)
- **CH4**: 간식 충동구매 (-1,000TC)
- **CH5**: 우산 잃어버림 (-1,000TC)
- **CH6**: 충전기 구매 (-1,000TC)
- **CH7**: 버스카드 충전 (-1,000TC)

**구현 내용**:
```typescript
// 플레이어 돈 업데이트
await client.query(
  'UPDATE player_states SET money = money + $1 WHERE id = $2',
  [moneyChange, playerStateId]
);
```

### 2. 상호작용 카드 (6장)
- **CH8**: 친구와 집안일 (집안일 카드 공유)
- **CH9**: 공동 지원 이벤트 (여행지원 카드 공유)
- **CH10**: 계획 구매 요청 (1,000TC에 카드 거래)
- **CH11**: 계획 교환 (2인 금지)
- **CH12**: 모두 내 자리로 (2인 금지)
- **CH13**: 자리 바꾸기 (2인 금지)

**구현 내용**:
- 대상 선택 모달 시스템
- 상호작용 타임아웃 (30초)
- 2인 플레이 금지 체크 (`forbidden_2p`)
- 카드 소유권 이전
- 위치 이동 및 `forced_move` 플래그

### 3. 드로우 카드 (3장)
- **CH14**: 여행 이야기 듣기 (계획 카드 최저 플레이어에게 지급)
- **CH15**: 좋은 정보 발견 (계획 카드 1장 드로우)
- **CH16**: 버린만큼 뽑기 (버린 카드 수만큼 드로우)

**구현 내용**:
```typescript
// 계획 카드 최저 플레이어 찾기
SELECT ps.id, ps.player_id, COUNT(h.id) as card_count
FROM player_states ps
LEFT JOIN hands h ON ps.id = h.player_state_id
WHERE ps.game_id = $1
GROUP BY ps.id, ps.player_id
ORDER BY card_count ASC
LIMIT 1
```

### 4. 특수 행동 카드 (1장)
- **CH20**: 공동 목표 지원 (3,000TC 기여) ✅ 수정 완료

**수정 내용**:
```typescript
// 플레이어 돈 차감
await client.query(
  'UPDATE player_states SET money = money - 3000 WHERE id = $1',
  [playerStateId]
);

// 공동 목표 기여
await client.query(
  'INSERT INTO joint_plan_contributions (game_id, player_state_id, amount) VALUES ($1, $2, 3000)',
  [gameId, playerStateId]
);
```

### 5. 캐치업 카드 (4장)
- **CH21**: 엄마의 응원 (TC 최저 플레이어에게 +2,000TC)
- **CH22**: 여행 선생님의 조언 (계획 카드 최저 플레이어에게 지급)
- **CH23**: 가족 사진 대작전 (추억 최저 플레이어에게 +2)
- **CH24**: 엄마의 응원 메시지 (추억 최저 플레이어에게 +2)

**구현 내용**:
```typescript
// TC 최저 플레이어 찾기
SELECT player_id, money
FROM player_states
WHERE game_id = $1
ORDER BY money ASC
LIMIT 1

// 추억 최저 플레이어 찾기
SELECT player_id, traits
FROM player_states
WHERE game_id = $1
ORDER BY (traits->>'memory')::int ASC NULLS FIRST
LIMIT 1
```

---

## ⚠️ 부분 구현된 카드 (5장) - 프론트엔드 작업 필요

### CH17: 여행 팜플렛
**현재 상태**: 백엔드 구현 완료, 프론트엔드 모달 필요

**백엔드 구현**:
```typescript
// 상호작용 요청 생성
this.io?.to(gameId).emit('chance-request', {
  interactionId,
  type: 'select_joint_plan',
  requesterId: playerId,
  message: '공동 목표 카드를 선택하세요'
});
```

**필요 작업**:
- [ ] 프론트엔드: 공동 목표 카드 선택 모달 구현
- [ ] 선택한 카드를 공동 목표로 설정하는 API 연결

### CH18: 체력이 넘친다!
**현재 상태**: 메시지만 반환

**백엔드 구현**:
```typescript
return { 
  type: 'special', 
  action: 'extra_action', 
  message: '이동 없이 행동 1회를 수행할 수 있습니다' 
};
```

**필요 작업**:
- [ ] 프론트엔드: 추가 행동 처리 로직 구현
- [ ] 이동 없이 행동 가능하도록 상태 관리
- [ ] 행동 선택 UI 표시

### CH19: 반전의 기회
**현재 상태**: 현재 위치 반환

**백엔드 구현**:
```typescript
return { 
  type: 'special', 
  action: 'repeat_current', 
  position: currentPosition,
  message: `현재 위치(${currentPosition}번)에서 행동을 1회 더 수행할 수 있습니다`
};
```

**필요 작업**:
- [ ] 프론트엔드: 현재 위치에서 추가 행동 처리
- [ ] 행동 선택 UI 표시

### CH25: 동행 버디
**현재 상태**: 백엔드 구현 완료, 프론트엔드 처리 필요

**백엔드 구현**:
```typescript
// 대상 선택 요청
this.io?.to(gameId).emit('chance-request', {
  interactionId,
  type: 'buddy_action',
  requesterId,
  message: '동행 버디: 함께 행동할 플레이어를 선택하세요'
});
```

**필요 작업**:
- [ ] 프론트엔드: 대상 선택 후 두 플레이어 추가 행동 처리
- [ ] 행동 선택 UI 표시

---

## 🔧 수정 완료 사항

### 1. CH20 공동 목표 지원 수정
**문제**: 기여만 하고 돈을 차감하지 않음

**수정 내용**:
- ✅ 플레이어 돈에서 3,000TC 차감
- ✅ 돈이 부족한 경우 에러 메시지 반환
- ✅ 공동 목표 기여 테이블에 3,000TC 추가
- ✅ 로그 및 메시지 개선

### 2. 찬스 카드 효과 메시지 개선
**수정 내용**:
- ✅ 돈 카드: 증감 금액 및 현재 잔액 표시
- ✅ 드로우 카드: 명확한 메시지 표시
- ✅ 캐치업 카드: 대상 플레이어 및 효과 표시

### 3. 타입 에러 수정
**수정 내용**:
- ✅ `handleDrawCard` 함수 반환 타입 명시
- ✅ TypeScript 타입 에러 해결

---

## 📋 테스트 체크리스트

### 즉시 테스트 가능 (21장)

#### 우선순위 1: 기본 효과
- [ ] CH1-CH7: 돈 증감 효과 확인
- [ ] CH14, CH15: 카드 드로우 확인
- [ ] CH20: 공동 목표 지원 (돈 차감 확인)
- [ ] CH21: TC 캐치업 확인
- [ ] CH23, CH24: 추억 캐치업 확인

#### 우선순위 2: 상호작용
- [ ] CH8: 친구와 집안일 (대상 선택 및 효과)
- [ ] CH9: 공동 지원 이벤트 (대상 선택 및 효과)
- [ ] CH10: 계획 구매 요청 (거래 시스템)

#### 우선순위 3: 2인 금지
- [ ] CH11: 계획 교환 (2인 플레이 시 사용 불가)
- [ ] CH12: 모두 내 자리로 (2인 플레이 시 사용 불가)
- [ ] CH13: 자리 바꾸기 (2인 플레이 시 사용 불가)

#### 우선순위 4: 특수 효과
- [ ] CH16: 버린만큼 뽑기 (버린 카드 수 계산)
- [ ] CH22: 여행 선생님의 조언 (계획 카드 최저 플레이어)

### 프론트엔드 작업 후 테스트 (5장)
- [ ] CH17: 여행 팜플렛 (공동 목표 선택)
- [ ] CH18: 체력이 넘친다! (추가 행동)
- [ ] CH19: 반전의 기회 (현재 칸 반복)
- [ ] CH25: 동행 버디 (두 플레이어 추가 행동)

---

## 🎯 권장 테스트 순서

### 1단계: 기본 효과 테스트 (5분)
1. CH1 획득 → 돈 +3,000TC 확인
2. CH3 획득 → 돈 -1,000TC 확인
3. CH15 획득 → 계획 카드 1장 손패 추가 확인

### 2단계: 캐치업 테스트 (10분)
1. 플레이어 간 TC 차이 만들기
2. CH21 획득 → TC 최저 플레이어에게 +2,000TC 확인
3. CH23 획득 → 추억 최저 플레이어에게 +2 확인

### 3단계: 상호작용 테스트 (15분)
1. CH8 획득 → 대상 선택 모달 → 집안일 카드 공유 확인
2. CH10 획득 → 카드 구매 제안 → 거래 확인
3. CH13 획득 (3인 이상) → 위치 교환 확인

### 4단계: 2인 금지 테스트 (5분)
1. 2인 플레이 시작
2. CH11, CH12, CH13 획득 시도
3. 사용 불가 메시지 확인

### 5단계: 특수 효과 테스트 (10분)
1. 카드 여러 장 버리기
2. CH16 획득 → 버린 카드 수만큼 드로우 확인
3. CH20 획득 → 돈 차감 및 공동 목표 기여 확인

---

## 📝 알려진 제한사항

### 1. 프론트엔드 미구현 기능
- CH17: 공동 목표 선택 모달
- CH18, CH19: 추가 행동 처리
- CH25: 동행 버디 추가 행동

### 2. 테스트 필요 사항
- 음수 방지 (돈이 0 이하로 떨어지지 않는지)
- 덱 소진 시 처리
- 동시 상호작용 요청 처리
- 타임아웃 처리

### 3. 개선 가능 사항
- 찬스 카드 효과 애니메이션
- 더 명확한 효과 메시지
- 상호작용 히스토리 로그

---

## 🎉 결론

### 구현 완료도: 80.8% (21/26장)

**완전 구현된 기능**:
- ✅ 모든 돈 카드 (7장)
- ✅ 모든 상호작용 카드 (6장)
- ✅ 모든 드로우 카드 (3장)
- ✅ 대부분의 캐치업 카드 (4/5장)
- ✅ 일부 특수 행동 카드 (1/4장)

**남은 작업**:
- ⚠️ 프론트엔드 추가 행동 처리 (CH18, CH19, CH25)
- ⚠️ 공동 목표 선택 모달 (CH17)

**테스트 준비 완료**:
- 21장의 찬스 카드는 즉시 테스트 가능
- 5장은 프론트엔드 작업 후 테스트 가능

**다음 단계**:
1. 21장의 완전 구현된 카드 테스트
2. 버그 발견 시 수정
3. 프론트엔드 추가 기능 구현
4. 나머지 5장 테스트

