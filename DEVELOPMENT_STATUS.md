# 열네 밤의 꿈 - 개발 진행 상태

## 📊 전체 진행률: **35%**

---

## 1. 워크플로우별 진행 상태

### 🟢 1.00 로비/방 관리 (Room Management) - **80%**

#### ✅ 완료
- [x] 방 생성 API (`POST /rooms`)
- [x] 방 참여 API (`POST /rooms/:code/join`)
- [x] 방 상태 조회 API (`GET /rooms/:roomId`)
- [x] 닉네임 중복 시 suffix 자동 부여
- [x] WebSocket 연결 구조 (`/ws/rooms/:roomId`)
- [x] 참여자 브로드캐스트 이벤트 (`player-joined`, `player-left`)
- [x] 데이터베이스 스키마 (ROOM, PLAYER, USER)

#### ⚠️ 미완성
- [ ] 방장 권한 관리 (방장 확인 로직)
- [ ] 동시 start 요청 중복 방지 (낙관락/분산락)
- [ ] WS 연결 수 모니터링
- [ ] 참가/퇴장 브로드캐스트 지연 측정 (≤ 300ms 목표)

---

### 🟢 2.00 게임 세팅/초기화 (Rule Setup) - **70%**

#### ✅ 완료
- [x] 게임 시작 API (`POST /rooms/:roomId/start`)
- [x] 6종 덱 셔플 로직 (plan/freeplan/house/invest/chance/joint/travel)
- [x] 여행지 카드 1장 오픈
- [x] 공동 계획 카드 1장 오픈
- [x] 초기 자원 지급 (돈 2,000, 위치 1, 계획 1장, 결심 토큰 1)
- [x] 선플레이어 랜덤 결정 및 턴 순서 저장
- [x] 데이터베이스 스키마 (GAME, PLAYERSTATE, DECK, CARD)
- [x] WS 이벤트 구조 (`game.setup.completed`)

#### ⚠️ 미완성
- [ ] 중복 시작 방지 (트랜잭션 강화)
- [ ] 최소 인원 검증 (2인 이상)
- [ ] 카드 리소스 누락 시 롤백 처리
- [ ] 전체 카드 데이터 시드 (현재 샘플만 존재)
  - [ ] 여행지 10장 (현재 5장)
  - [ ] 일반 계획 40장 (현재 8장)
  - [ ] 투자 16장 (현재 8장)
  - [ ] 찬스 20장 (현재 5장)
  - [ ] 공동 계획 10장 (현재 3장)

---

### 🟡 3.00 턴 루프/카드 행동 (Turn & Card Action) - **40%**

#### ✅ 완료
- [x] 이동 API (`POST /games/:gameId/move`)
- [x] 행동 API (`POST /games/:gameId/action`)
- [x] 인접 칸 검증 로직
- [x] 연속 사용 금지 규칙 (같은 칸 연속 불가)
- [x] 6가지 행동 기본 구조
  - [x] 1번: 무료 계획 드로우
  - [x] 2번: 조사하기 (계획 드로우)
  - [x] 3번: 집안일 (드로우 + 수익)
  - [x] 4번: 투자 (드로우 + 손익)
  - [x] 5번: 찬스 (드로우만, 효과 미구현)
  - [x] 6번: 자유 행동 (결심 토큰 체크만)
- [x] 턴 시작 WS 이벤트 (`turn-started`)
- [x] 상태 업데이트 WS 이벤트 (`state-updated`)

#### ⚠️ 미완성
- [ ] **Turn Lock 구현** (현재 턴 플레이어 외 요청 Reject)
- [ ] 찬스 카드 특수 로직 (20장 중 상호작용 카드)
  - [ ] C8: 친구랑 같이 집안일 (강제 이동 + 수익 공유)
  - [ ] C9: 공동 투자
  - [ ] C10: 계획 구매 요청 (대상 응답 대기)
  - [ ] C11: 계획 교환 (양방향 선택)
  - [ ] C12: 모두 내 자리로 (전체 이동)
  - [ ] C13: 자릿수 바꾸기 (위치 교환)
  - [ ] C14-C20: 기타 찬스 카드
- [ ] 찬스 상호작용 타임아웃 처리 (30초)
- [ ] 공동 계획 기여 API (`POST /games/:gameId/contribute`)
- [ ] 공동 계획 기여 트랜잭션 (원자성 보장)
- [ ] 턴 종료 및 다음 플레이어 전환 로직
- [ ] 14일차 루프 관리
- [ ] 7일차 결심 토큰 재충전
- [ ] 결심 토큰 사용 시 연속 금지 규칙 적용
- [ ] 이벤트 로그 기록 (EVENTLOG)
- [ ] 동시 요청 방지 (Double Click, Race Condition)

---

### 🔴 4.00 최종 정산/리플레이 (End Game & Replay) - **0%**

#### ⚠️ 미구현
- [ ] 최종 구매 API (`POST /games/:gameId/finalize`)
- [ ] 점수 계산 로직
  - [ ] 여행지 배수 적용 (메인 x3, 일반 x2, 서브 x1)
  - [ ] 추억 점수 합산
  - [ ] 공동 계획 성공/실패 판정
  - [ ] 공동 계획 패널티 (최저 기여자 추억 -2, 2인 예외)
  - [ ] 최다 기여 보너스
- [ ] 결과 전송 (`GameResult` 객체)
- [ ] 결과 화면 동기화 (N개 닫기 신호 수신)
- [ ] 소프트 리셋 API (`POST /rooms/:roomId/soft-reset`)
- [ ] 소프트 리셋 로직
  - [ ] 게임 데이터 초기화
  - [ ] 방 상태 → `waiting` 전환
  - [ ] 플레이어 목록 유지
- [ ] 결과 닫기 신호 누락 시 폴백 (1분 타이머)
- [ ] 데이터베이스 스키마 (PURCHASED, GAMERESULT)

---

### 🔴 5.00 동시성/예외/복구 (Advanced Workflow) - **10%**

#### ✅ 완료
- [x] 기본 에러 핸들링 구조

#### ⚠️ 미구현
- [ ] Turn Locking (현재 턴 플레이어 외 Reject/Queue)
- [ ] 공동 계획 기여 동시성 처리 (DB 트랜잭션)
- [ ] 찬스 상호작용 타임아웃 (30초 + 강제 거절)
- [ ] AFK 처리 (5분 유지 → Bot 대행)
- [ ] 접속 끊김 복구 (재연결 시 상태 복원)
- [ ] 영구 이탈 처리 (게임 지속 또는 종료)
- [ ] Rate Limiting
- [ ] 에러 WS 채널 (`error.rate_limited`, `error.invalid_turn`, `timeout.interaction`)
- [ ] 강제 재시작 API (관리용)

---

## 2. 데이터/인프라 진행 상태

### 🟢 데이터베이스 - **90%**

#### ✅ 완료
- [x] ERD 설계 완료
- [x] PostgreSQL 스키마 작성
- [x] 모든 테이블 정의 (14개)
- [x] 인덱스 설정
- [x] 외래키 제약조건
- [x] 샘플 카드 데이터 시드

#### ⚠️ 미완성
- [ ] 전체 카드 데이터 시드 (여행지 10장, 계획 40장, 찬스 20장 등)
- [ ] 마이그레이션 도구 설정

---

### 🟡 WebSocket - **50%**

#### ✅ 완료
- [x] Socket.io 설정
- [x] 방 참여/나가기 이벤트
- [x] 기본 브로드캐스트 구조
- [x] 턴 시작 알림
- [x] 찬스 요청/응답 이벤트 구조

#### ⚠️ 미완성
- [ ] 상태 동기화 최적화
- [ ] 연결 끊김 처리
- [ ] 재연결 로직
- [ ] 지연 측정 (p95 ≤ 300ms)

---

### 🔴 프론트엔드 - **0%**

#### ⚠️ 미구현
- [ ] React 프로젝트 설정
- [ ] 로비 화면
- [ ] 게임 보드 UI
- [ ] 플레이어 상태 표시
- [ ] 카드 UI
- [ ] 찬스 상호작용 모달
- [ ] 결과 화면
- [ ] WebSocket 클라이언트 연결

---

### 🔴 MLOps/배포 - **0%**

#### ⚠️ 미구현
- [ ] GitHub Actions 워크플로우
- [ ] Docker 컨테이너화
- [ ] AWS 인프라 설정 (EKS, RDS, ElastiCache)
- [ ] Blue/Green 배포
- [ ] 모니터링 (CloudWatch, OpenTelemetry)
- [ ] 헬스체크 엔드포인트 강화

---

## 3. 기능별 우선순위

### 🔥 High Priority (즉시 필요)
1. **Turn Lock 구현** - 동시성 제어 핵심
2. **전체 카드 데이터 시드** - 게임 플레이 필수
3. **찬스 카드 상호작용 로직** - 게임 재미 핵심
4. **턴 종료 및 다음 플레이어 전환** - 게임 진행 필수
5. **공동 계획 기여 시스템** - 핵심 메커니즘

### ⚙️ Medium Priority (곧 필요)
6. **최종 정산 로직** - 게임 완료 필수
7. **소프트 리셋** - 재플레이 기능
8. **프론트엔드 기본 UI** - 테스트 및 플레이 가능
9. **AFK/접속 끊김 처리** - 안정성
10. **이벤트 로그 기록** - 디버깅 및 리플레이

### 📦 Low Priority (나중에)
11. MLOps 파이프라인
12. 모니터링 대시보드
13. 관전자 모드
14. 랭킹 시스템

---

## 4. 예상 작업량

### 남은 작업 시간 추정
- **Turn Lock & 동시성**: 4-6시간
- **찬스 카드 전체 구현**: 8-12시간
- **공동 계획 시스템**: 4-6시간
- **최종 정산 로직**: 6-8시간
- **소프트 리셋**: 3-4시간
- **전체 카드 데이터**: 4-6시간
- **프론트엔드 기본**: 20-30시간
- **테스트 & 버그 수정**: 10-15시간

**총 예상**: 60-90시간

---

## 5. 다음 단계 권장 순서

1. ✅ **전체 카드 데이터 시드 완성** (4-6시간)
2. ✅ **Turn Lock 구현** (4-6시간)
3. ✅ **턴 종료 및 플레이어 전환** (3-4시간)
4. ✅ **찬스 카드 상호작용 (C8-C13)** (8-12시간)
5. ✅ **공동 계획 기여 시스템** (4-6시간)
6. ✅ **최종 정산 로직** (6-8시간)
7. ✅ **소프트 리셋** (3-4시간)
8. ✅ **프론트엔드 MVP** (20-30시간)

---

## 6. 위험 요소

### 🚨 Critical
- Turn Lock 없이는 동시성 문제 발생 가능
- 찬스 카드 타임아웃 미구현 시 게임 멈춤 가능

### ⚠️ Warning
- 카드 데이터 없으면 테스트 불가
- 프론트엔드 없으면 실제 플레이 테스트 불가

### 💡 Info
- MLOps는 초기 버전에서 선택사항
- 관전자 모드는 추후 추가 가능

---

## 📝 요약

**현재 상태**: 기본 인프라와 핵심 API 구조는 완성. 게임 로직의 세부 구현과 프론트엔드가 필요한 상태.

**강점**: 
- 탄탄한 데이터베이스 설계
- 명확한 API 구조
- WebSocket 실시간 동기화 기반 마련

**약점**:
- 찬스 카드 상호작용 미구현
- 턴 관리 로직 불완전
- 프론트엔드 부재

**권장**: 백엔드 핵심 로직 완성 후 프론트엔드 개발 시작
