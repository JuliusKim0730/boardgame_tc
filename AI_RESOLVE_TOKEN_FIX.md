# AI 플레이어 결심 토큰 사용 및 턴 종료 수정 (2024-12-03)

## 문제점

결심 토큰 기능이 추가되면서 AI 플레이어의 턴 종료 루틴이 누락되었습니다.
- AI가 행동 후 턴을 종료하지 않음
- 결심 토큰 사용 로직이 없음

## 해결 방안

### 1. AI 턴 실행 플로우 수정

```
1. 이동 결정 및 실행
   ↓
2. 행동 결정 및 실행
   ↓
3. 찬스 카드 처리 (필요 시)
   ↓
4. 결심 토큰 사용 결정 ← 신규 추가
   ↓
5. 턴 종료 ← 복원
```

### 2. 결심 토큰 사용 전략

#### 사용 시기
- **2-5일 중 랜덤하게 1번 사용**
  - Day 2: 25% 확률
  - Day 3: 33% 확률
  - Day 4: 50% 확률
  - Day 5: 100% 확률 (마지막 기회)

- **10-12일 중 랜덤하게 1번 사용**
  - Day 10: 33% 확률
  - Day 11: 50% 확률
  - Day 12: 100% 확률 (마지막 기회)

#### 사용 로직
```typescript
private async shouldUseResolveTokenNow(gameId: string, playerId: string): Promise<boolean> {
  // 1. 현재 날짜 확인
  // 2. 토큰 보유 여부 확인
  // 3. 사용 이력 조회
  // 4. 2-5일 구간 체크
  // 5. 10-12일 구간 체크
  // 6. 확률적으로 사용 결정
}
```

#### 추가 행동 선택
결심 토큰 사용 시 직전 행동을 제외하고 다음 우선순위로 선택:
1. 2번 (조사하기) - 계획 카드 드로우
2. 3번 (집안일) - TC 획득
3. 4번 (여행지원) - TC 획득
4. 1번 (무료계획) - 무료 카드 드로우
5. 나머지 행동

### 3. 구현 내용

#### `shouldUseResolveTokenNow()` 메서드
- 현재 날짜와 토큰 사용 이력을 기반으로 사용 여부 결정
- 2-5일 구간과 10-12일 구간에서 확률적으로 사용
- 각 구간에서 1번만 사용하도록 제한

#### `useResolveToken()` 메서드
- 토큰 차감
- 사용 로그 기록 (날짜 포함)
- 추가 행동 선택 및 수행
- 직전 행동 칸 제외

#### `executeTurn()` 메서드 수정
```typescript
async executeTurn(gameId: string, playerId: string): Promise<void> {
  // 1. 이동
  // 2. 행동
  // 3. 찬스 카드 처리
  
  // 4. 결심 토큰 사용 결정 (신규)
  const shouldUseToken = await this.shouldUseResolveTokenNow(gameId, playerId);
  if (shouldUseToken) {
    await this.useResolveToken(gameId, playerId);
  }
  
  // 5. 턴 종료 (복원)
  await turnManager.endTurn(gameId, playerId);
}
```

## 변경 파일

### `backend/src/services/AIPlayerService.ts`
- `shouldUseResolveTokenNow()` 메서드 추가
- `useResolveToken()` 메서드 추가
- `executeTurn()` 메서드 수정 (결심 토큰 사용 및 턴 종료 로직 추가)
- `decideAction()` 메서드 제거 (미사용)

## 테스트 체크리스트

### AI 턴 종료
- [ ] AI가 행동 후 자동으로 턴 종료
- [ ] 다음 플레이어로 턴 전환 확인

### 결심 토큰 사용
- [ ] Day 2-5 구간에서 1번 사용 확인
- [ ] Day 10-12 구간에서 1번 사용 확인
- [ ] 각 구간에서 최대 1번만 사용 확인
- [ ] 토큰 차감 확인
- [ ] 사용 로그 기록 확인

### 추가 행동
- [ ] 직전 행동 칸 제외 확인
- [ ] 우선순위에 따른 행동 선택 확인
- [ ] 추가 행동 수행 확인

### 게임 플로우
- [ ] AI 턴 → 결심 토큰 사용 → 턴 종료 → 다음 턴 시작
- [ ] 여러 AI 플레이어 순차 진행 확인
- [ ] Day 전환 정상 작동 확인

## 예상 동작

### Day 3 AI 턴 예시
```
🤖 AI 이동 결정: 1 → 2
🤖 AI 행동 결정: 2번 (위치 2)
✅ AI 행동 완료
🔥 AI 결심 토큰 사용 결정 (33% 확률로 선택됨)
🔥 AI 결심 토큰 사용: 3번 행동 수행
✅ AI 결심 토큰 사용 완료
🤖 AI 턴 종료 중...
✅ AI 턴 완료
```

### Day 11 AI 턴 예시
```
🤖 AI 이동 결정: 3 → 5
🤖 AI 행동 결정: 5번 (위치 5)
✅ AI 행동 완료
🔥 AI 결심 토큰 사용 결정 (50% 확률로 선택됨)
🔥 AI 결심 토큰 사용: 2번 행동 수행
✅ AI 결심 토큰 사용 완료
🤖 AI 턴 종료 중...
✅ AI 턴 완료
```

## 결론

AI 플레이어가 이제 다음과 같이 동작합니다:
1. ✅ 행동 후 자동으로 턴 종료
2. ✅ 2-5일 중 1번 결심 토큰 사용
3. ✅ 10-12일 중 1번 결심 토큰 사용
4. ✅ 확률적으로 자연스러운 사용 패턴
5. ✅ 직전 행동 제외 규칙 준수

게임 플로우가 정상적으로 진행됩니다.
