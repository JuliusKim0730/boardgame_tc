# 카드 시스템

## 카드 타입

총 107장의 카드

### 1. 계획 카드 (Plan) - 40장
- 코드: P1 ~ P40
- 획득: 조사하기 (2번 칸)
- 용도: 손패에 추가 → 최종 구매
- 비용: 1,000 ~ 9,000TC
- 효과: 특성 점수 증가

**예시**:
```json
{
  "code": "P1",
  "name": "맛집 탐방",
  "cost": 2000,
  "effects": {
    "taste": 2,
    "memory": 1
  }
}
```

### 2. 무료 계획 카드 (Free Plan) - 10장
- 코드: F1 ~ F10
- 획득: 무료 계획 (1번 칸)
- 용도: 손패에 추가 → 최종 구매
- 비용: 0TC (무료)
- 효과: 특성 점수 증가 (계획 카드보다 낮음)

**예시**:
```json
{
  "code": "F1",
  "name": "무료 체험",
  "cost": 0,
  "effects": {
    "leisure": 1
  }
}
```

### 3. 집안일 카드 (House) - 10장
- 코드: H1 ~ H10
- 획득: 집안일 (3번 칸)
- 용도: 즉시 효과 (손패에 추가 안 됨)
- 효과: 돈 + 추억 점수

**예시**:
```json
{
  "code": "H1",
  "name": "설거지",
  "effects": {
    "money": 500,
    "memory": 1
  }
}
```

**2인 전용 규칙**:
- 첫 방문 시 +500TC 보너스

### 4. 여행 지원 카드 (Support) - 10장
- 코드: S1 ~ S10
- 획득: 여행 지원 (4번 칸)
- 용도: 즉시 효과 (손패에 추가 안 됨)
- 효과: 돈 증감

**예시**:
```json
{
  "code": "S1",
  "name": "용돈",
  "effects": {
    "money": 1000
  }
}
```

```json
{
  "code": "S5",
  "name": "긴급 지출",
  "effects": {
    "money": -500
  }
}
```

### 5. 찬스 카드 (Chance) - 25장
- 코드: CH1 ~ CH25
- 획득: 찬스 (5번 칸)
- 용도: 다양한 효과
- 분류: 즉시 효과, 상호작용, 카드 드로우, 추가 행동, 캐치업

#### 5-1. 즉시 효과 (CH1-CH7)
```json
// CH1: 돈 받기
{
  "code": "CH1",
  "name": "행운의 발견",
  "effects": { "money": 1000 }
}

// CH3: 돈 잃기
{
  "code": "CH3",
  "name": "분실",
  "effects": { "money": -500 }
}
```

#### 5-2. 상호작용 (CH8-CH13)
```json
// CH8: 돈 교환 요청
{
  "code": "CH8",
  "name": "돈 빌리기",
  "metadata": {
    "interaction": "request_money",
    "amount": 1000
  }
}

// CH10: 계획 구매 요청
{
  "code": "CH10",
  "name": "계획 구매 요청",
  "metadata": {
    "interaction": "request_purchase"
  }
}

// CH11: 카드 교환 요청
{
  "code": "CH11",
  "name": "카드 교환",
  "metadata": {
    "interaction": "request_card_swap",
    "forbidden_2p": true
  }
}
```

**2인 전용 규칙**:
- CH11, CH12, CH13은 2인 게임에서 제외

#### 5-3. 카드 드로우 (CH14-CH17)
```json
{
  "code": "CH14",
  "name": "추가 계획",
  "metadata": {
    "draw": "plan",
    "count": 1
  }
}
```

#### 5-4. 추가 행동 (CH18-CH19)
```json
{
  "code": "CH18",
  "name": "추가 기회",
  "metadata": {
    "special": "extra_action"
  }
}

{
  "code": "CH19",
  "name": "반전의 기회",
  "metadata": {
    "special": "repeat_current"
  }
}
```

#### 5-5. 공동 목표 (CH20)
```json
{
  "code": "CH20",
  "name": "공동 목표 지원",
  "metadata": {
    "special": "joint_plan_support",
    "amount": 1000
  }
}
```

#### 5-6. 캐치업 (CH21-CH25)
```json
{
  "code": "CH21",
  "name": "역전의 기회",
  "metadata": {
    "special": "catchup",
    "condition": "lowest_money"
  }
}
```

### 6. 여행지 카드 (Travel) - 10장
- 코드: T1 ~ T10
- 획득: 게임 시작 시 배정 (플레이어별 1장, 중복 없음)
- 용도: 특성 가중치 결정
- 효과: 특성별 가중치 (x1, x2, x3)

**예시**:
```json
{
  "code": "T1",
  "name": "제주도",
  "metadata": {
    "multipliers": {
      "nature": 3,
      "water": 2,
      "leisure": 1
    }
  }
}
```

**가중치 설명**:
- x3: 주요 특성 (1개)
- x2: 부차 특성 (1개)
- x1: 일반 특성 (4개)

### 7. 공동 계획 카드 (Joint Plan) - 2장
- 코드: J1 ~ J2
- 획득: 게임 시작 시 1장 선택
- 용도: 공동 목표
- 목표: 10,000TC 달성
- 보너스: 달성 시 +300점, 최다 기여자 +500점

**예시**:
```json
{
  "code": "J1",
  "name": "단체 여행",
  "cost": 10000,
  "effects": {
    "memory": 2
  },
  "metadata": {
    "description": "모두 함께 떠나는 여행",
    "bonus": "최다 기여자 +500점"
  }
}
```

## 카드 효과

### 특성 (Traits)
```typescript
{
  "taste": number,      // 맛
  "history": number,    // 역사
  "nature": number,     // 자연
  "culture": number,    // 문화
  "leisure": number,    // 여가
  "water": number,      // 물
  "memory": number      // 추억
}
```

### 돈 (Money)
```typescript
{
  "money": number  // 양수: 획득, 음수: 지출
}
```

### 메타데이터 (Metadata)
```typescript
{
  "description": string,           // 설명
  "interaction": string,           // 상호작용 타입
  "draw": string,                  // 드로우 타입
  "count": number,                 // 드로우 개수
  "special": string,               // 특수 효과
  "multipliers": object,           // 가중치 (여행지)
  "forbidden_2p": boolean,         // 2인 게임 제외
  "amount": number,                // 금액
  "condition": string              // 조건
}
```

## 덱 시스템

### 덱 생성
```typescript
// 게임 시작 시 5개 덱 생성
const deckTypes = ['plan', 'freeplan', 'house', 'support', 'chance'];

for (const type of deckTypes) {
  // 1. 해당 타입의 모든 카드 조회
  const cards = await getCardsByType(type);
  
  // 2. 셔플
  const shuffled = shuffle(cards);
  
  // 3. 덱 생성
  await createDeck(gameId, type, shuffled.map(c => c.id));
}
```

### 카드 드로우
```typescript
// 1. 덱 조회
const deck = await getDeck(gameId, deckType);

// 2. 첫 번째 카드 추출
const cardId = deck.card_order.shift();

// 3. 덱 업데이트
await updateDeck(gameId, deckType, deck.card_order);

// 4. 카드 정보 조회
const card = await getCard(cardId);

// 5. 손패 추가 (plan, freeplan만)
if (['plan', 'freeplan'].includes(deckType)) {
  await addToHand(playerStateId, cardId);
}

// 6. 즉시 효과 적용 (나머지)
else {
  await applyEffect(playerStateId, card.effects);
}
```

## 손패 관리

### 손패 추가
```typescript
// seq: 순서 (0, 1, 2, ...)
const nextSeq = await getNextSeq(playerStateId);
await insertHand(playerStateId, cardId, nextSeq);
```

### 손패 조회
```typescript
const handCards = await getHandCards(playerStateId);
// 결과: [{ id, card_id, seq, card: {...} }]
```

### 손패 제거 (최종 구매 시)
```typescript
await deleteHand(playerStateId, cardId);
```

## 구매 시스템

### 최종 구매
```typescript
// 1. 예산 확인
const totalCost = cardIds.reduce((sum, id) => {
  const card = handCards.find(c => c.id === id);
  return sum + card.cost;
}, 0);

if (totalCost > money) {
  throw new Error('예산 초과');
}

// 2. 구매 처리
for (const cardId of cardIds) {
  const card = handCards.find(c => c.id === cardId);
  
  // 손패에서 제거
  await deleteHand(playerStateId, cardId);
  
  // 구매 기록
  await insertPurchased(playerStateId, cardId, card.cost);
  
  // 특성 점수 적용
  await updateTraits(playerStateId, card.effects);
  
  // 돈 차감
  await updateMoney(playerStateId, -card.cost);
}
```

## 점수 계산

### 기본 점수
```typescript
// 특성 × 가중치 × 100
const baseScore = Object.entries(traits).reduce((sum, [trait, points]) => {
  if (trait === 'memory') return sum;
  const multiplier = travelMultipliers[trait] || 1;
  return sum + (points * multiplier * 100);
}, 0);
```

### 추억 점수
```typescript
const memoryScore = traits.memory * 100;
```

### 공동 계획 보너스
```typescript
const jointPlanBonus = isAchieved ? 300 : 0;
const topContributorBonus = isTopContributor ? 500 : 0;
```

### 총점
```typescript
const totalScore = baseScore + memoryScore + jointPlanBonus + topContributorBonus;
```

## 특성 변환

### 비주류 특성 변환
```typescript
// 가중치 1배 특성 3점 → 추억 1점
const minorTraits = Object.entries(traits).filter(([trait, points]) => {
  if (trait === 'memory') return false;
  const multiplier = travelMultipliers[trait] || 1;
  return multiplier === 1 && points >= 3;
});

// 최대 변환 횟수
const maxConversions = Math.floor(
  minorTraits.reduce((sum, [, points]) => sum + points, 0) / 3
);

// 변환 처리
for (let i = 0; i < conversions; i++) {
  // 비주류 특성 -3
  await updateTrait(playerStateId, minorTrait, -3);
  
  // 추억 +1
  await updateTrait(playerStateId, 'memory', +1);
}
```

## 카드 데이터 시드

### SQL 파일
- `backend/src/db/seedCards.sql` - 전체 카드 데이터 (107장)

### 실행 방법
```bash
psql -d boardgame -f backend/src/db/seedCards.sql
```

### 카드 수 확인
```sql
SELECT type, COUNT(*) as count
FROM cards
GROUP BY type
ORDER BY type;
```

**예상 결과**:
```
type      | count
----------+-------
chance    | 25
freeplan  | 10
house     | 10
joint     | 2
plan      | 40
support   | 10
travel    | 10
```

## 카드 밸런스

### 계획 카드 비용 분포
- 1,000 ~ 2,000TC: 저가 (10장)
- 3,000 ~ 5,000TC: 중가 (20장)
- 6,000 ~ 9,000TC: 고가 (10장)

### 특성 점수 분포
- 1점: 기본
- 2점: 일반
- 3점: 높음
- 4점 이상: 희귀

### 여행지 가중치
- 각 여행지마다 x3 1개, x2 1개, x1 4개
- 다양한 조합으로 전략 다양성 확보

## 카드 추가 가이드

### 1. 카드 데이터 추가
```sql
INSERT INTO cards (type, code, name, cost, effects, metadata)
VALUES (
  'plan',
  'P41',
  '새로운 계획',
  3000,
  '{"taste": 2, "culture": 1}'::jsonb,
  '{"description": "설명"}'::jsonb
);
```

### 2. 덱 재생성
게임 시작 시 자동으로 새 카드 포함

### 3. 밸런스 테스트
- 비용 대비 효과 적절한지 확인
- 다른 카드와 비교하여 밸런스 조정
