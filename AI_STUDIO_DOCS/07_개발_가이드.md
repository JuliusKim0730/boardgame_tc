# 개발 가이드

## 로컬 개발 환경 설정

### 1. 필수 요구사항
- Node.js 18 이상
- PostgreSQL 14 이상 (또는 Supabase)
- Git

### 2. 프로젝트 클론
```bash
git clone <repository-url>
cd boardgame-fourteen-nights
```

### 3. 데이터베이스 설정

#### 옵션 A: Supabase (권장)
```bash
# 1. https://supabase.com 가입
# 2. 새 프로젝트 생성
# 3. SQL Editor에서 스키마 실행
# backend/src/db/schema.sql
# backend/src/db/seedCards.sql
# backend/src/db/migration_v4.1.sql

# 4. 연결 정보 복사
# Settings → Database → Connection string
```

#### 옵션 B: 로컬 PostgreSQL
```bash
# PostgreSQL 설치
brew install postgresql  # macOS
sudo apt install postgresql  # Ubuntu

# 데이터베이스 생성
createdb boardgame

# 스키마 실행
psql -d boardgame -f backend/src/db/schema.sql
psql -d boardgame -f backend/src/db/seedCards.sql
psql -d boardgame -f backend/src/db/migration_v4.1.sql
```

### 4. 백엔드 설정
```bash
cd backend
npm install

# 환경 변수 설정
cp .env.example .env
# .env 파일 편집 (DB 연결 정보)

# 개발 서버 실행
npm run dev
```

### 5. 프론트엔드 설정
```bash
cd frontend
npm install

# 환경 변수 설정
cp .env.example .env
# .env 파일 편집 (API URL)

# 개발 서버 실행
npm run dev
```

### 6. 확인
- 백엔드: http://localhost:4000/api/health
- 프론트엔드: http://localhost:3000

## 환경 변수

### backend/.env
```env
# 데이터베이스
DB_HOST=localhost
DB_PORT=5432
DB_NAME=boardgame
DB_USER=postgres
DB_PASSWORD=your-password

# 서버
PORT=4000
NODE_ENV=development

# 클라이언트 URL (CORS)
CLIENT_URL=http://localhost:3000
```

### frontend/.env
```env
# API URL
VITE_API_URL=http://localhost:4000/api
VITE_SOCKET_URL=http://localhost:4000
```

## 개발 워크플로우

### 1. 기능 추가

#### 백엔드
```typescript
// 1. 서비스 로직 작성
// backend/src/services/NewService.ts
export class NewService {
  async newMethod() {
    // 로직
  }
}

// 2. 라우트 추가
// backend/src/routes/newRoutes.ts
router.post('/new-endpoint', async (req, res) => {
  try {
    const result = await newService.newMethod();
    res.json(result);
  } catch (error: any) {
    res.status(400).json({ error: error.message });
  }
});

// 3. server.ts에 라우트 등록
import newRoutes from './routes/newRoutes';
app.use('/api', newRoutes);
```

#### 프론트엔드
```typescript
// 1. API 함수 추가
// frontend/src/services/api.ts
export const apiService = {
  newMethod: () => api.post('/new-endpoint')
};

// 2. 컴포넌트에서 사용
// frontend/src/components/NewComponent.tsx
const handleAction = async () => {
  const response = await apiService.newMethod();
  // 처리
};
```

### 2. 데이터베이스 변경

#### 마이그레이션 작성
```sql
-- backend/src/db/migration_vX.X.sql

-- 새 컬럼 추가
ALTER TABLE player_states 
ADD COLUMN new_field INT DEFAULT 0;

-- 새 테이블 추가
CREATE TABLE new_table (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ...
);

-- 인덱스 추가
CREATE INDEX idx_new_field ON player_states(new_field);
```

#### 마이그레이션 실행
```bash
psql -d boardgame -f backend/src/db/migration_vX.X.sql
```

### 3. 카드 추가

#### 카드 데이터 추가
```sql
-- backend/src/db/seedCards.sql에 추가

INSERT INTO cards (type, code, name, cost, effects, metadata)
VALUES (
  'plan',
  'P41',
  '새로운 계획',
  3000,
  '{"taste": 2, "culture": 1}'::jsonb,
  '{"description": "새로운 계획 설명"}'::jsonb
);
```

#### 카드 시드 재실행
```bash
# 기존 카드 삭제 후 재시드
psql -d boardgame -c "DELETE FROM cards;"
psql -d boardgame -f backend/src/db/seedCards.sql
```

### 4. WebSocket 이벤트 추가

#### 백엔드
```typescript
// backend/src/ws/gameSocket.ts
socket.on('new-event', (data) => {
  // 처리
  io.to(data.roomId).emit('new-event-response', result);
});
```

#### 프론트엔드
```typescript
// frontend/src/components/GameScreen.tsx
useEffect(() => {
  const socket = socketService.connect(roomId);
  
  socket.on('new-event-response', (data) => {
    // 처리
  });
  
  return () => socketService.disconnect();
}, [roomId]);
```

## 디버깅

### 백엔드 로그
```typescript
// 상세 로그 추가
console.log('=== 함수명 ===');
console.log('변수:', variable);
console.log('상태:', state);
```

### 프론트엔드 로그
```typescript
// 개발자 도구 콘솔
console.log('상태:', gameState);
console.log('플레이어:', playerState);
```

### 데이터베이스 쿼리
```sql
-- 게임 상태 확인
SELECT * FROM games WHERE id = 'game-id';

-- 플레이어 상태 확인
SELECT * FROM player_states WHERE game_id = 'game-id';

-- 손패 확인
SELECT h.*, c.name 
FROM hands h 
JOIN cards c ON h.card_id = c.id 
WHERE h.player_state_id = 'player-state-id';

-- 이벤트 로그 확인
SELECT * FROM event_logs 
WHERE game_id = 'game-id' 
ORDER BY created_at DESC 
LIMIT 20;
```

### 진단 도구
```bash
# 로컬 환경 체크
node check-local-setup.js

# 데이터 동기화 디버그
node debug-data-sync.js
```

## 테스트

### 수동 테스트 시나리오

#### 1. 기본 플로우
```
1. 방 생성 (플레이어1)
2. 방 참여 (플레이어2)
3. 게임 시작
4. 턴 진행 (이동 → 행동 → 턴 종료)
5. 14일차까지 진행
6. 최종 구매
7. 특성 변환
8. 결과 확인
```

#### 2. AI 플레이어 테스트
```
1. 방 생성
2. AI 플레이어 추가 (닉네임: "로봇1", "로봇2")
3. 게임 시작
4. AI 자동 플레이 확인
```

#### 3. 2인 전용 규칙 테스트
```
1. 2인 방 생성
2. 찬스 칸 (5번) 이동
3. 카드/돈 선택 모달 확인
4. 집안일 (3번) 첫 방문 보너스 확인
```

#### 4. 공동 계획 테스트
```
1. 게임 진행 중 공동 계획 기여
2. 10,000TC 달성 확인
3. 최종 정산 시 보너스 확인
```

### 자동 테스트 (향후 추가)
```bash
# 단위 테스트
npm test

# E2E 테스트
npm run test:e2e
```

## 배포

### 백엔드 (Render.com)

#### 1. Render 설정
```yaml
# render.yaml
services:
  - type: web
    name: boardgame-backend
    env: node
    buildCommand: cd backend && npm install && npm run build
    startCommand: cd backend && npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: DB_HOST
        sync: false
      - key: DB_PORT
        sync: false
      - key: DB_NAME
        sync: false
      - key: DB_USER
        sync: false
      - key: DB_PASSWORD
        sync: false
      - key: CLIENT_URL
        sync: false
```

#### 2. 환경 변수 설정
- Render 대시보드 → Environment
- DB 연결 정보 입력
- CLIENT_URL 입력 (Vercel URL)

#### 3. 배포
```bash
git push origin main
# Render 자동 배포
```

### 프론트엔드 (Vercel)

#### 1. Vercel 설정
```json
// vercel.json
{
  "buildCommand": "cd frontend && npm ci && npm run build",
  "outputDirectory": "frontend/dist",
  "framework": "vite"
}
```

#### 2. 환경 변수 설정
- Vercel 대시보드 → Settings → Environment Variables
- `VITE_API_URL`: Render 백엔드 URL
- `VITE_SOCKET_URL`: Render 백엔드 URL

#### 3. 배포
```bash
git push origin main
# Vercel 자동 배포
```

## 트러블슈팅

### 문제: 데이터베이스 연결 실패
```bash
# 연결 정보 확인
psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME

# Supabase: IPv6 문제
# → IPv4 주소 사용 또는 Pooler 사용
```

### 문제: Socket 연결 실패
```typescript
// CORS 설정 확인
// backend/src/server.ts
const allowedOrigins = [
  'http://localhost:3000',
  'https://your-frontend.vercel.app'
];
```

### 문제: 턴 락 에러
```typescript
// 턴 락 초기화
turnManager.releaseTurnLock(gameId);

// 또는 서버 재시작
npm run dev
```

### 문제: 손패 업데이트 안 됨
```typescript
// 게임 상태 새로고침
await loadGameState();

// 또는 500ms 대기 후 새로고침
setTimeout(() => loadGameState(), 500);
```

## 코드 스타일

### TypeScript
```typescript
// 명확한 타입 정의
interface GameState {
  day: number;
  status: string;
  currentTurnPlayerId: string | null;
}

// async/await 사용
async function loadGameState() {
  try {
    const response = await api.getGameState(gameId);
    // 처리
  } catch (error: any) {
    console.error('에러:', error);
  }
}

// 명확한 함수명
function handleMove(position: number) { ... }
function handleAction(actionType: number) { ... }
```

### SQL
```sql
-- 명확한 컬럼명
SELECT 
  ps.id,
  ps.money,
  ps.position,
  u.nickname
FROM player_states ps
JOIN players p ON ps.player_id = p.id
JOIN users u ON p.user_id = u.id
WHERE ps.game_id = $1;

-- 인덱스 활용
CREATE INDEX idx_player_states_game ON player_states(game_id);
```

### CSS
```css
/* BEM 네이밍 */
.game-screen { }
.game-screen__header { }
.game-screen__content { }
.game-screen--active { }

/* CSS Variables */
:root {
  --primary-color: #667eea;
  --spacing-sm: 8px;
  --spacing-md: 16px;
}
```

## 참고 문서

### 프로젝트 문서
- `README.md` - 프로젝트 개요
- `QUICK_START_UPDATED.md` - 빠른 시작
- `LOCAL_ISSUE_FIX_GUIDE.md` - 로컬 이슈 해결
- `DATABASE_MIGRATION_GUIDE.md` - DB 마이그레이션

### 워크플로우
- `workflows/1.00_로비_방관리.md`
- `workflows/2.00_게임세팅_초기화.md`
- `workflows/3.00_턴루프_카드행동.md`
- `workflows/4.00_최종정산_리플레이.md`
- `workflows/5.00_동시성_예외복구.md`

### 구현 완료 보고서
- `FINAL_COMPLETION_REPORT_V4.1.md`
- `IMPLEMENTATION_COMPLETE_V4.1.md`
- `AI_PLAYER_ALGORITHM_COMPLETE.md`
- `HAND_CARDS_AND_AI_FIX.md`

### AI Studio 문서
- `AI_STUDIO_DOCS/00_프로젝트_개요.md`
- `AI_STUDIO_DOCS/01_데이터베이스_구조.md`
- `AI_STUDIO_DOCS/02_백엔드_아키텍처.md`
- `AI_STUDIO_DOCS/03_프론트엔드_구조.md`
- `AI_STUDIO_DOCS/04_게임_플로우.md`
- `AI_STUDIO_DOCS/05_API_명세.md`
- `AI_STUDIO_DOCS/06_카드_시스템.md`
- `AI_STUDIO_DOCS/07_개발_가이드.md` (이 문서)

## 추가 개발 아이디어

### 단기 (1-2주)
- [ ] AFK/접속 끊김 처리
- [ ] 리플레이 시스템
- [ ] 게임 통계 (승률, 평균 점수)
- [ ] 채팅 기능

### 중기 (1-2개월)
- [ ] 랭킹 시스템
- [ ] 친구 시스템
- [ ] 커스텀 룰 설정
- [ ] 모바일 앱 (React Native)

### 장기 (3개월 이상)
- [ ] 시즌제 도입
- [ ] 새로운 카드 팩
- [ ] 토너먼트 모드
- [ ] AI 난이도 조절

## 기여 가이드

### 1. 이슈 생성
- 버그 리포트
- 기능 제안
- 문서 개선

### 2. Pull Request
```bash
# 브랜치 생성
git checkout -b feature/new-feature

# 커밋
git commit -m "feat: 새로운 기능 추가"

# 푸시
git push origin feature/new-feature

# PR 생성
```

### 3. 코드 리뷰
- 코드 스타일 준수
- 테스트 통과
- 문서 업데이트

## 라이선스

MIT License

## 연락처

- GitHub: [repository-url]
- Email: [email]
