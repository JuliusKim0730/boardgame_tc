# ê²Œì„ í”Œë¡œìš°

## ì „ì²´ íë¦„

```
1. ë¡œë¹„ â†’ 2. ëŒ€ê¸°ì‹¤ â†’ 3. ê²Œì„ ì´ˆê¸°í™” â†’ 4. í„´ ë£¨í”„ (14ì¼) â†’ 5. ìµœì¢… ì •ì‚° â†’ 6. ê²°ê³¼ í™”ë©´
```

## 1. ë¡œë¹„ (ë°© ìƒì„±/ì°¸ì—¬)

### ë°© ìƒì„±
```
ì‚¬ìš©ì ì…ë ¥: ë‹‰ë„¤ì„
â†“
POST /api/rooms { nickname }
â†“
ì‘ë‹µ: { roomId, code, userId, playerId }
â†“
ëŒ€ê¸°ì‹¤ë¡œ ì´ë™
```

### ë°© ì°¸ì—¬
```
ì‚¬ìš©ì ì…ë ¥: ë‹‰ë„¤ì„, ë°© ì½”ë“œ (4ìë¦¬)
â†“
POST /api/rooms/:code/join { nickname }
â†“
ì‘ë‹µ: { roomId, userId, playerId }
â†“
ëŒ€ê¸°ì‹¤ë¡œ ì´ë™
```

## 2. ëŒ€ê¸°ì‹¤

### í”Œë ˆì´ì–´ ëŒ€ê¸°
```
WebSocket ì—°ê²° (roomId)
â†“
socket.emit('join-room', roomId)
â†“
í”Œë ˆì´ì–´ ëª©ë¡ í‘œì‹œ
- ì²« ë²ˆì§¸ í”Œë ˆì´ì–´: ë°©ì¥ (ğŸ‘‘)
- ë‚˜ë¨¸ì§€ í”Œë ˆì´ì–´: ì¼ë°˜
â†“
ë°©ì¥ë§Œ "ê²Œì„ ì‹œì‘" ë²„íŠ¼ í™œì„±í™”
```

### ê²Œì„ ì‹œì‘
```
ë°©ì¥ í´ë¦­: "ê²Œì„ ì‹œì‘"
â†“
POST /api/rooms/:roomId/start
â†“
GameSetupService.initializeGame()
- games ë ˆì½”ë“œ ìƒì„±
- player_states ìƒì„± (í„´ ìˆœì„œ ëœë¤)
- 5ê°œ ë± ìƒì„± ë° ì…”í”Œ
- ì—¬í–‰ì§€ ì¹´ë“œ ë°°ì •
- ê³µë™ ê³„íš ì¹´ë“œ ì„ íƒ
- ì²« ë²ˆì§¸ í„´ ì‹œì‘
â†“
socket.emit('game-started', { gameId })
â†“
ëª¨ë“  í”Œë ˆì´ì–´ â†’ ê²Œì„ í™”ë©´ìœ¼ë¡œ ì´ë™
```

## 3. ê²Œì„ ì´ˆê¸°í™”

### ë± ìƒì„±
```typescript
// 5ê°œ ë± ìƒì„±
const deckTypes = ['plan', 'freeplan', 'house', 'support', 'chance'];

for (const type of deckTypes) {
  // í•´ë‹¹ íƒ€ì…ì˜ ëª¨ë“  ì¹´ë“œ ì¡°íšŒ
  const cards = await getCardsByType(type);
  
  // ì…”í”Œ
  const shuffled = shuffle(cards);
  
  // ë± ìƒì„±
  await createDeck(gameId, type, shuffled.map(c => c.id));
}
```

### ì—¬í–‰ì§€ ë°°ì •
```typescript
// ì—¬í–‰ì§€ ì¹´ë“œ 10ì¥ ì¤‘ í”Œë ˆì´ì–´ ìˆ˜ë§Œí¼ ëœë¤ ì„ íƒ (ì¤‘ë³µ ì—†ì´)
const travelCards = await getCardsByType('travel');
const shuffled = shuffle(travelCards);
const selected = shuffled.slice(0, playerCount);

// ê° í”Œë ˆì´ì–´ì—ê²Œ ë°°ì •
for (let i = 0; i < playerCount; i++) {
  await assignTravelCard(playerStates[i].id, selected[i].id);
}
```

### ê³µë™ ê³„íš ì„ íƒ
```typescript
// ê³µë™ ê³„íš ì¹´ë“œ 2ì¥ ì¤‘ 1ì¥ ëœë¤ ì„ íƒ
const jointCards = await getCardsByType('joint');
const selected = jointCards[Math.floor(Math.random() * jointCards.length)];

// ê²Œì„ì— ì„¤ì •
await setJointPlanCard(gameId, selected.id);
```

## 4. í„´ ë£¨í”„ (14ì¼)

### í„´ ì‹œì‘
```
TurnManager.startTurn(gameId, playerId)
â†“
1. í„´ ë½ ì„¤ì •
   turnLocks.set(gameId, playerId)
â†“
2. turns ë ˆì½”ë“œ ìƒì„±
   INSERT INTO turns (game_id, day, player_state_id, started_at)
â†“
3. WebSocket ì•Œë¦¼
   socket.emit('turn-started', { playerId, day })
â†“
4. í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
   - isMyTurn = true
   - hasMoved = false
   - hasActed = false
   - message = "ë‹¹ì‹ ì˜ í„´ì…ë‹ˆë‹¤!"
```

### ì´ë™ ë‹¨ê³„
```
ì‚¬ìš©ì í´ë¦­: ì¸ì ‘ ì¹¸
â†“
POST /api/games/:gameId/move { playerId, position }
â†“
TurnService.move()
1. í„´ ë½ ê²€ì¦
   validateTurn(gameId, playerId)
2. ì¸ì ‘ ì¹¸ ê²€ì¦
   adjacentPositions.includes(position)
3. ì—°ì† ì‚¬ìš© ê¸ˆì§€ ê²€ì¦
   position !== lastPosition
4. ìœ„ì¹˜ ì—…ë°ì´íŠ¸
   UPDATE player_states SET position = ?, last_position = ?
5. ì´ë²¤íŠ¸ ë¡œê·¸
   INSERT INTO event_logs (event_type='move', data)
â†“
í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
- hasMoved = true
- message = "í–‰ë™ì„ ì„ íƒí•˜ì„¸ìš”"
```

### í–‰ë™ ë‹¨ê³„
```
ì‚¬ìš©ì í´ë¦­: í–‰ë™ ë²„íŠ¼ (1~6ë²ˆ)
â†“
POST /api/games/:gameId/action { playerId, actionType }
â†“
TurnService.performAction()
1. í„´ ë½ ê²€ì¦
2. í–‰ë™ íƒ€ì…ë³„ ì²˜ë¦¬
   - 1ë²ˆ: freeplan ì¹´ë“œ ë“œë¡œìš°
   - 2ë²ˆ: plan ì¹´ë“œ ë“œë¡œìš°
   - 3ë²ˆ: house ì¹´ë“œ ë“œë¡œìš° + ì¦‰ì‹œ íš¨ê³¼
   - 4ë²ˆ: support ì¹´ë“œ ë“œë¡œìš° + ì¦‰ì‹œ íš¨ê³¼
   - 5ë²ˆ: chance ì¹´ë“œ ë“œë¡œìš° (2ì¸: ì„ íƒ ëª¨ë‹¬)
   - 6ë²ˆ: ììœ  í–‰ë™ (1~5ë²ˆ ì¤‘ ì„ íƒ)
3. ì¹´ë“œ ë“œë¡œìš°
   - ë±ì—ì„œ ì¹´ë“œ ID ì¶”ì¶œ
   - plan/freeplan: hands í…Œì´ë¸”ì— ì¶”ê°€
   - ë‚˜ë¨¸ì§€: ì¦‰ì‹œ íš¨ê³¼ ì ìš©
4. ì´ë²¤íŠ¸ ë¡œê·¸
â†“
WebSocket ì•Œë¦¼
socket.emit('action-completed', { playerId, actionType, result })
â†“
í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
- hasActed = true
- ì¹´ë“œ ë“œë¡œìš° ëª¨ë‹¬ í‘œì‹œ (í•´ë‹¹ ì‹œ)
- ì†íŒ¨ ì—…ë°ì´íŠ¸
```

### í„´ ì¢…ë£Œ
```
ìë™ ì‹¤í–‰ (2ì´ˆ í›„)
â†“
POST /api/games/:gameId/end-turn { playerId }
â†“
TurnManager.endTurn()
1. í˜„ì¬ í„´ ì¢…ë£Œ
   UPDATE turns SET ended_at = NOW()
2. ë‹¤ìŒ í”Œë ˆì´ì–´ ê²°ì •
   - í„´ ìˆœì„œëŒ€ë¡œ ìˆœí™˜
   - ëª¨ë“  í”Œë ˆì´ì–´ ì™„ë£Œ ì‹œ day++
3. 14ì¼ì°¨ ì²´í¬
   - day > 14: status = 'finalizing'
   - ì•„ë‹ˆë©´: ë‹¤ìŒ í„´ ì‹œì‘
4. í„´ ë½ í•´ì œ ë° ì¬ì„¤ì •
   releaseTurnLock(gameId)
   setTurnLock(gameId, nextPlayerId)
â†“
WebSocket ì•Œë¦¼
socket.emit('turn-started', { playerId: nextPlayerId, day })
â†“
ë‹¤ìŒ í”Œë ˆì´ì–´ í„´ ì‹œì‘
```

### íŠ¹ìˆ˜ ì´ë²¤íŠ¸

#### 7ì¼ì°¨ ì‹œì‘ (ê²°ì‹¬ í† í° íšŒë³µ)
```
day === 7 && í„´ ì‹œì‘
â†“
TurnService.checkResolveTokenRecovery()
1. 1~6ì¼ì°¨ ë™ì•ˆ ê²°ì‹¬ í† í° ì‚¬ìš© ì—¬ë¶€ í™•ì¸
   SELECT COUNT(*) FROM event_logs 
   WHERE event_type = 'resolve_token_used'
2. ë¯¸ì‚¬ìš© ì‹œ í† í° 1ê°œ íšŒë³µ (ìµœëŒ€ 2ê°œ)
   UPDATE player_states 
   SET resolve_token = LEAST(resolve_token + 1, 2)
â†“
WebSocket ì•Œë¦¼
socket.emit('resolve-token-recovered', { playerId, newCount })
```

#### 2ì¸ ì „ìš©: ì§‘ì•ˆì¼ ì²« ë°©ë¬¸ ë³´ë„ˆìŠ¤
```
2ì¸ ê²Œì„ && í–‰ë™ 3ë²ˆ (ì§‘ì•ˆì¼) && ì²« ë°©ë¬¸
â†“
1. ì²« ë°©ë¬¸ í™•ì¸
   SELECT COUNT(*) FROM event_logs 
   WHERE event_type = 'action_3' AND playerId = ?
2. ì²« ë°©ë¬¸ì´ë©´ +500TC
   UPDATE player_states SET money = money + 500
â†“
WebSocket ì•Œë¦¼
socket.emit('house-first-visit-bonus', { playerId, bonus: 500 })
```

## 5. ìµœì¢… ì •ì‚°

### 14ì¼ì°¨ ì¢…ë£Œ
```
day > 14
â†“
UPDATE games SET status = 'finalizing'
â†“
WebSocket ì•Œë¦¼
socket.emit('day-14-completed')
â†“
í”„ë¡ íŠ¸ì—”ë“œ: ìµœì¢… êµ¬ë§¤ í™”ë©´ í‘œì‹œ
```

### ìµœì¢… êµ¬ë§¤
```
ì‚¬ìš©ì: ì†íŒ¨ì—ì„œ êµ¬ë§¤í•  ì¹´ë“œ ì„ íƒ
â†“
POST /api/games/:gameId/final-purchase { playerId, cardIds }
â†“
GameFinalizationService.finalPurchase()
1. ì˜ˆì‚° í™•ì¸
   totalCost = Î£(card.cost)
   if (totalCost > money) throw Error
2. êµ¬ë§¤ ì²˜ë¦¬
   - handsì—ì„œ ì‚­ì œ
   - purchasedì— ì¶”ê°€
   - money ì°¨ê°
3. íŠ¹ì„± ì ìˆ˜ ì ìš©
   UPDATE player_states 
   SET traits = jsonb_set(traits, ...)
â†“
í”„ë¡ íŠ¸ì—”ë“œ: íŠ¹ì„± ë³€í™˜ í™”ë©´ í‘œì‹œ
```

### ë¹„ì£¼ë¥˜ íŠ¹ì„± ë³€í™˜
```
ì‚¬ìš©ì: ë³€í™˜ íšŸìˆ˜ ì„ íƒ
â†“
POST /api/games/:gameId/convert-traits { playerId, conversions }
â†“
GameFinalizationService.convertMinorTraits()
1. ë¹„ì£¼ë¥˜ íŠ¹ì„± í™•ì¸ (ê°€ì¤‘ì¹˜ 1ë°°)
2. ë³€í™˜ ì²˜ë¦¬ (3ì  â†’ ì¶”ì–µ 1ì )
   - ë¹„ì£¼ë¥˜ íŠ¹ì„± -3
   - ì¶”ì–µ +1
3. ìµœëŒ€ ë³€í™˜ íšŸìˆ˜ ì œí•œ
â†“
í”„ë¡ íŠ¸ì—”ë“œ: ì ìˆ˜ ê³„ì‚° ëŒ€ê¸°
```

### ì ìˆ˜ ê³„ì‚°
```
ëª¨ë“  í”Œë ˆì´ì–´ êµ¬ë§¤ & ë³€í™˜ ì™„ë£Œ
â†“
POST /api/games/:gameId/finalize
â†“
GameFinalizationService.calculateFinalScore()
1. ê° í”Œë ˆì´ì–´ë³„ ì ìˆ˜ ê³„ì‚°
   baseScore = Î£(trait Ã— multiplier Ã— 100)
   memoryScore = memory Ã— 100
   jointPlanBonus = achieved ? 300 : 0
   topContributorBonus = isTop ? 500 : 0
   totalScore = baseScore + memoryScore + jointPlanBonus + topContributorBonus
2. game_results í…Œì´ë¸”ì— ì €ì¥
3. ìˆœìœ„ ê²°ì • (totalScore ë‚´ë¦¼ì°¨ìˆœ)
â†“
UPDATE games SET status = 'finished'
â†“
WebSocket ì•Œë¦¼
socket.emit('game-ended', { gameId })
â†“
í”„ë¡ íŠ¸ì—”ë“œ: ê²°ê³¼ í™”ë©´ í‘œì‹œ
```

## 6. ê²°ê³¼ í™”ë©´

### ê²°ê³¼ í‘œì‹œ
```
GET /api/games/:gameId/finalize
â†“
ì‘ë‹µ: [
  {
    playerId,
    nickname,
    totalScore,
    breakdown: {
      baseScore,
      memoryScore,
      jointPlanBonus,
      topContributorBonus,
      details: { trait: { points, multiplier, score } }
    }
  }
]
â†“
ìˆœìœ„ë³„ í‘œì‹œ
- 1ìœ„: ğŸ¥‡
- 2ìœ„: ğŸ¥ˆ
- 3ìœ„: ğŸ¥‰
- 4ìœ„: 4ìœ„
```

### ê²°ê³¼ í™•ì¸ ì™„ë£Œ
```
ì‚¬ìš©ì í´ë¦­: "ë‹¤ì‹œ í•˜ê¸°" ë˜ëŠ” "ë¡œë¹„ë¡œ"
â†“
POST /api/games/:gameId/result-closed { playerId }
â†“
GameFinalizationService.recordResultClosed()
1. ê²°ê³¼ í™•ì¸ ê¸°ë¡
2. ëª¨ë“  í”Œë ˆì´ì–´ í™•ì¸ ì™„ë£Œ ì‹œ
   - ë°© ìƒíƒœ ì´ˆê¸°í™” ê°€ëŠ¥
â†“
"ë‹¤ì‹œ í•˜ê¸°": ì†Œí”„íŠ¸ ë¦¬ì…‹ â†’ ëŒ€ê¸°ì‹¤
"ë¡œë¹„ë¡œ": ë°© ë‚˜ê°€ê¸° â†’ ë¡œë¹„
```

## AI í”Œë ˆì´ì–´ íë¦„

### AI í„´ ê°ì§€
```
AIScheduler (5ì´ˆë§ˆë‹¤)
â†“
SELECT * FROM games 
WHERE status = 'running' 
AND current_turn_player_id IN (
  SELECT player_id FROM players 
  WHERE nickname LIKE '%ë¡œë´‡%' OR nickname LIKE '%AI%'
)
â†“
AI í„´ ë°œê²¬ ì‹œ
AIPlayerService.executeTurn(gameId, playerId)
```

### AI í„´ ì‹¤í–‰
```
1. ê²Œì„ ìƒíƒœ ì¡°íšŒ
   - ì—¬í–‰ì§€ í…Œë§ˆ (ê°€ì¤‘ì¹˜)
   - í˜„ì¬ ìœ„ì¹˜
   - ì†Œì§€ê¸ˆ
   - ì†íŒ¨
   - ê²°ì‹¬ í† í° ì‚¬ìš© ì´ë ¥
â†“
2. ì´ë™ ê²°ì •
   - ëˆ ë¶€ì¡±: ì§‘ì•ˆì¼(3) ë˜ëŠ” ì—¬í–‰ì§€ì›(4)
   - ì—¬ìœ : ì¡°ì‚¬í•˜ê¸°(2) ìš°ì„ 
   - ê°€ë”: ì°¬ìŠ¤(5)
â†“
3. í–‰ë™ ê²°ì •
   - 6ë²ˆ ì¹¸: ê²°ì‹¬ í† í° ì „ëµ (1-7í„´ 1ê°œ, 8-14í„´ 1ê°œ)
   - ë‚˜ë¨¸ì§€: í•´ë‹¹ ì¹¸ í–‰ë™
â†“
4. í„´ ì¢…ë£Œ
   - 2ì´ˆ ëŒ€ê¸° (ìì—°ìŠ¤ëŸ¬ìš´ í”Œë ˆì´)
   - ë‹¤ìŒ í”Œë ˆì´ì–´ë¡œ ì „í™˜
```

### AI ìµœì¢… ì •ì‚°
```
1. ê³µë™ ê³„íš ê¸°ì—¬
   - 3,000 ~ 9,000TC (500 ë‹¨ìœ„)
â†“
2. ìµœì¢… êµ¬ë§¤
   - ì—¬í–‰ì§€ í…Œë§ˆì— ë§ëŠ” ì¹´ë“œ ìš°ì„ 
   - ê°€ì¤‘ì¹˜ ë†’ì€ íŠ¹ì„± ìš°ì„ 
   - ì˜ˆì‚° ë‚´ ìµœëŒ€ êµ¬ë§¤
â†“
3. íŠ¹ì„± ë³€í™˜
   - ëª¨ë“  ë¹„ì£¼ë¥˜ íŠ¹ì„± ë³€í™˜
```

## ì—ëŸ¬ ì²˜ë¦¬

### í„´ ë½ ìœ„ë°˜
```
ë‹¤ë¥¸ í”Œë ˆì´ì–´ í„´ì— í–‰ë™ ì‹œë„
â†“
validateTurn() ì‹¤íŒ¨
â†“
throw Error('ë‹¹ì‹ ì˜ í„´ì´ ì•„ë‹™ë‹ˆë‹¤')
â†“
í”„ë¡ íŠ¸ì—”ë“œ: ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
```

### ì—°ì† ì‚¬ìš© ê¸ˆì§€ ìœ„ë°˜
```
ì§ì „ ìœ„ì¹˜ë¡œ ì´ë™ ì‹œë„
â†“
if (position === lastPosition) throw Error
â†“
í”„ë¡ íŠ¸ì—”ë“œ: ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
```

### ì¸ì ‘ ì¹¸ ìœ„ë°˜
```
ì¸ì ‘í•˜ì§€ ì•Šì€ ì¹¸ìœ¼ë¡œ ì´ë™ ì‹œë„
â†“
if (!adjacentPositions.includes(position)) throw Error
â†“
í”„ë¡ íŠ¸ì—”ë“œ: ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
```

### ì˜ˆì‚° ì´ˆê³¼
```
ìµœì¢… êµ¬ë§¤ ì‹œ ì˜ˆì‚° ì´ˆê³¼
â†“
if (totalCost > money) throw Error
â†“
í”„ë¡ íŠ¸ì—”ë“œ: ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
```

## ë™ì‹œì„± ì œì–´

### í„´ ë½
```
ë©”ëª¨ë¦¬ ê¸°ë°˜ Map
turnLocks: Map<gameId, playerId>

ì„¤ì •: setTurnLock(gameId, playerId)
ê²€ì¦: validateTurn(gameId, playerId)
í•´ì œ: releaseTurnLock(gameId)
```

### íŠ¸ëœì­ì…˜
```
ì¤‘ìš”í•œ ì‘ì—…ì€ íŠ¸ëœì­ì…˜ ì‚¬ìš©
- ê²Œì„ ì´ˆê¸°í™”
- í„´ ì¢…ë£Œ
- ìµœì¢… êµ¬ë§¤
- ì ìˆ˜ ê³„ì‚°

BEGIN
  ì‘ì—…1
  ì‘ì—…2
  ì‘ì—…3
COMMIT (ì„±ê³µ ì‹œ)
ROLLBACK (ì‹¤íŒ¨ ì‹œ)
```
