# 백엔드 아키텍처

## 전체 구조

```
backend/src/
├── server.ts              # 서버 엔트리포인트
├── db/
│   ├── pool.ts           # PostgreSQL 연결 풀
│   ├── schema.sql        # 스키마 정의
│   └── seedCards.sql     # 카드 데이터
├── routes/
│   ├── roomRoutes.ts     # 방 관리 API
│   └── gameRoutes.ts     # 게임 플레이 API
├── services/
│   ├── RoomService.ts              # 방 생성/참여
│   ├── GameSetupService.ts         # 게임 초기화
│   ├── TurnService.ts              # 턴 행동 처리
│   ├── TurnManager.ts              # 턴 관리 & 락
│   ├── ChanceService.ts            # 찬스 카드
│   ├── JointPlanService.ts         # 공동 계획
│   ├── GameFinalizationService.ts  # 최종 정산
│   ├── AIPlayerService.ts          # AI 플레이어
│   └── AIScheduler.ts              # AI 스케줄러
└── ws/
    └── gameSocket.ts     # WebSocket 이벤트
```

## 주요 서비스

### 1. RoomService (방 관리)

**책임**: 방 생성, 참여, 조회

**주요 메서드**:
```typescript
class RoomService {
  // 방 생성 (4자리 코드 생성)
  async createRoom(hostNickname: string): Promise<Room>
  
  // 방 참여
  async joinRoom(code: string, nickname: string): Promise<JoinResult>
  
  // 방 조회
  async getRoom(roomId: string): Promise<Room>
  
  // 방 코드로 조회
  async getRoomByCode(code: string): Promise<Room>
  
  // 소프트 리셋 (게임 재시작)
  async softReset(roomId: string): Promise<void>
}
```

**코드 생성 로직**:
```typescript
// 4자리 대문자 (예: ABCD, XYZW)
const code = Array.from({ length: 4 }, () => 
  String.fromCharCode(65 + Math.floor(Math.random() * 26))
).join('');
```

### 2. GameSetupService (게임 초기화)

**책임**: 게임 시작 시 초기 설정

**주요 메서드**:
```typescript
class GameSetupService {
  // 게임 초기화
  async initializeGame(roomId: string): Promise<Game>
  
  // 덱 생성 (5개 덱 셔플)
  private async createDecks(gameId: string): Promise<void>
  
  // 여행지 배정 (플레이어별 다른 여행지)
  private async assignTravelDestinations(gameId: string): Promise<void>
  
  // 공동 계획 카드 선택
  private async selectJointPlanCard(gameId: string): Promise<void>
  
  // 턴 순서 결정
  private async determineTurnOrder(gameId: string): Promise<void>
}
```

**초기화 순서**:
1. `games` 레코드 생성 (status='setting')
2. `player_states` 생성 (턴 순서 랜덤)
3. 5개 덱 생성 및 셔플
4. 여행지 카드 배정 (중복 없이)
5. 공동 계획 카드 선택
6. 첫 번째 플레이어 턴 시작
7. status='running'으로 변경

### 3. TurnService (턴 행동 처리)

**책임**: 이동, 행동, 카드 드로우

**주요 메서드**:
```typescript
class TurnService {
  // 이동
  async move(gameId: string, playerId: string, targetPosition: number): Promise<void>
  
  // 행동 (1~6번)
  async performAction(gameId: string, playerId: string, actionType: number): Promise<ActionResult>
  
  // 카드 드로우 (내부 메서드)
  private async drawCard(client: any, gameId: string, playerStateId: string, deckType: string): Promise<Card>
  
  // 결심 토큰 사용
  async useResolveToken(gameId: string, playerId: string, actionType: number): Promise<void>
  
  // 2인 전용: 찬스 칸 돈 지급
  async applyMoneyBonus(gameId: string, playerId: string, amount: number): Promise<void>
  
  // 2인 전용: 찬스 카드 드로우
  async drawChanceCard(gameId: string, playerId: string): Promise<Card>
  
  // 결심 토큰 회복 체크 (7일차)
  async checkResolveTokenRecovery(gameId: string): Promise<void>
}
```

**행동 타입**:
```typescript
1: 무료 계획 - freeplan 카드 1장
2: 조사하기 - plan 카드 1장
3: 집안일 - house 카드 (즉시 효과)
4: 여행 지원 - support 카드 (즉시 효과)
5: 찬스 - chance 카드 (다양한 효과)
6: 자유 행동 - 1~5번 중 선택 (결심 토큰 필요)
```

**이동 규칙**:
```typescript
// 인접 칸만 이동 가능
const adjacency = {
  1: [2, 3],      // 무료계획 → 조사하기, 집안일
  2: [1, 4],      // 조사하기 → 무료계획, 여행지원
  3: [1, 5],      // 집안일 → 무료계획, 찬스
  4: [2, 5, 6],   // 여행지원 → 조사하기, 찬스, 자유행동
  5: [3, 4, 6],   // 찬스 → 집안일, 여행지원, 자유행동
  6: [4, 5]       // 자유행동 → 여행지원, 찬스
};

// 연속 사용 금지
if (targetPosition === lastPosition) {
  throw new Error('같은 칸을 연속으로 사용할 수 없습니다');
}
```

### 4. TurnManager (턴 관리 & 락)

**책임**: 턴 순서 관리, 동시성 제어

**주요 메서드**:
```typescript
class TurnManager {
  // 턴 락 설정
  setTurnLock(gameId: string, playerId: string): void
  
  // 턴 락 해제
  releaseTurnLock(gameId: string): void
  
  // 턴 검증
  validateTurn(gameId: string, playerId: string): void
  
  // 턴 종료
  async endTurn(gameId: string, playerId: string): Promise<EndTurnResult>
  
  // 다음 플레이어 결정
  private async getNextPlayer(gameId: string, currentPlayerId: string): Promise<Player>
  
  // 턴 락 복원 (서버 재시작 시)
  async restoreTurnLocks(): Promise<void>
}
```

**턴 락 메커니즘**:
```typescript
// 메모리 기반 락
private turnLocks: Map<string, string> = new Map();

// 락 설정
setTurnLock(gameId: string, playerId: string) {
  this.turnLocks.set(gameId, playerId);
}

// 검증
validateTurn(gameId: string, playerId: string) {
  const lockedPlayerId = this.turnLocks.get(gameId);
  if (lockedPlayerId !== playerId) {
    throw new Error('당신의 턴이 아닙니다');
  }
}
```

### 5. ChanceService (찬스 카드)

**책임**: 찬스 카드 효과 처리

**주요 메서드**:
```typescript
class ChanceService {
  // 찬스 카드 실행
  async executeChance(gameId: string, playerId: string, cardCode: string): Promise<ChanceResult>
  
  // 상호작용 요청 (CH8-CH13)
  async requestInteraction(gameId: string, fromPlayerId: string, toPlayerId: string, chanceData: any): Promise<void>
  
  // 상호작용 응답
  async respondToInteraction(interactionId: string, response: boolean): Promise<void>
}
```

**찬스 카드 분류**:
```typescript
// 즉시 효과 (CH1-CH7)
CH1, CH2: 돈 받기
CH3-CH7: 돈 잃기

// 상호작용 (CH8-CH13)
CH8, CH9: 돈 교환 요청
CH10: 계획 구매 요청
CH11-CH13: 카드 교환 요청

// 카드 드로우 (CH14-CH17)
CH14-CH17: 추가 카드 획득

// 추가 행동 (CH18-CH19)
CH18, CH19: 추가 행동 기회

// 공동 목표 (CH20)
CH20: 공동 계획 지원

// 캐치업 (CH21-CH25)
CH21-CH25: 뒤처진 플레이어 지원
```

### 6. JointPlanService (공동 계획)

**책임**: 공동 계획 기여 관리

**주요 메서드**:
```typescript
class JointPlanService {
  // 기여
  async contribute(gameId: string, playerId: string, amount: number): Promise<void>
  
  // 현황 조회
  async getContributionStatus(gameId: string): Promise<ContributionStatus>
  
  // 최다 기여자 확인
  async getTopContributor(gameId: string): Promise<Player>
  
  // 달성 여부 확인
  async isAchieved(gameId: string): Promise<boolean>
}
```

**기여 규칙**:
- 목표 금액: 10,000TC
- 기여 단위: 500TC
- 최다 기여자 보너스: 추가 점수

### 7. GameFinalizationService (최종 정산)

**책임**: 게임 종료 시 점수 계산

**주요 메서드**:
```typescript
class GameFinalizationService {
  // 최종 구매
  async finalPurchase(gameId: string, playerId: string, cardIds: string[]): Promise<void>
  
  // 비주류 특성 변환
  async convertMinorTraits(gameId: string, playerId: string, conversions: number): Promise<void>
  
  // 최종 점수 계산
  async calculateFinalScore(gameId: string): Promise<GameResult[]>
  
  // 결과 창 닫기 기록
  async recordResultClosed(gameId: string, playerId: string): Promise<boolean>
}
```

**점수 계산 공식**:
```typescript
// 1. 기본 점수 (특성 × 가중치)
baseScore = Σ(trait_points × multiplier × 100)

// 2. 추억 점수
memoryScore = memory_points × 100

// 3. 공동 계획 보너스
jointPlanBonus = achieved ? 300 : 0
topContributorBonus = isTopContributor ? 500 : 0

// 4. 총점
totalScore = baseScore + memoryScore + jointPlanBonus + topContributorBonus
```

### 8. AIPlayerService (AI 플레이어)

**책임**: AI 자동 플레이

**주요 메서드**:
```typescript
class AIPlayerService {
  // AI 턴 실행
  async executeTurn(gameId: string, playerId: string): Promise<void>
  
  // 이동 결정
  private async decideMove(gameState: GameState): Promise<number>
  
  // 행동 결정
  private async decideAction(gameState: GameState, position: number): Promise<number>
  
  // 공동 계획 기여 결정
  async decideJointPlanContribution(gameId: string, playerId: string): Promise<number>
  
  // 최종 구매 결정
  async decideFinalPurchase(gameId: string, playerId: string): Promise<string[]>
  
  // 특성 변환 결정
  async decideTraitConversion(gameId: string, playerId: string): Promise<number>
}
```

**AI 전략**:
1. 여행지 테마에 맞춰 특성 집중 (x3 > x2 > x1)
2. 돈이 부족하면 집안일/여행지원 우선
3. 결심 토큰: 1-7턴 1개, 8-14턴 1개 사용
4. 공동 계획: 3,000~9,000TC 기여
5. 최종 구매: 가중치 높은 카드 우선

### 9. AIScheduler (AI 스케줄러)

**책임**: AI 턴 자동 실행

**주요 메서드**:
```typescript
class AIScheduler {
  // 스케줄러 시작
  start(): void
  
  // 스케줄러 중지
  stop(): void
  
  // AI 턴 체크 및 실행
  private async checkAndExecuteAITurns(): Promise<void>
  
  // AI 공동 계획 기여
  async checkAIJointPlanContributions(gameId: string): Promise<void>
  
  // AI 최종 구매
  async executeAIFinalPurchases(gameId: string): Promise<void>
  
  // AI 특성 변환
  async executeAITraitConversions(gameId: string): Promise<void>
}
```

**스케줄링**:
- 5초마다 AI 턴 체크
- AI 플레이어 감지: 닉네임에 "로봇", "AI", "봇", "기계" 포함
- 각 AI 턴 사이 2초 대기

## WebSocket 이벤트

### gameSocket.ts

**클라이언트 → 서버**:
```typescript
'join-room': (roomId: string)
'leave-room': (roomId: string)
'game-state-update': { roomId, state }
'turn-started': { roomId, playerId }
'chance-request': { roomId, targetPlayerId, chanceData }
'chance-response': { roomId, response }
```

**서버 → 클라이언트**:
```typescript
'player-joined': { socketId, timestamp }
'player-left': { socketId, timestamp }
'state-updated': state
'turn-started': { playerId, day, timestamp }
'action-completed': { playerId, actionType, result }
'chance-request': { targetPlayerId, chanceData, timestamp }
'chance-resolved': { response, timestamp }
'game-ended': { gameId }
'day-7-started': { message }
'resolve-token-recovered': { playerId, newCount }
'house-first-visit-bonus': { playerId, bonus }
```

## 에러 처리

### 공통 에러
```typescript
try {
  // 비즈니스 로직
} catch (error: any) {
  console.error('에러:', error);
  res.status(400).json({ error: error.message });
}
```

### 트랜잭션
```typescript
const client = await pool.connect();
try {
  await client.query('BEGIN');
  // 작업
  await client.query('COMMIT');
} catch (error) {
  await client.query('ROLLBACK');
  throw error;
} finally {
  client.release();
}
```

## 환경 변수

```env
# 데이터베이스
DB_HOST=localhost
DB_PORT=5432
DB_NAME=boardgame
DB_USER=postgres
DB_PASSWORD=password

# 서버
PORT=4000
NODE_ENV=development

# 클라이언트 URL (CORS)
CLIENT_URL=http://localhost:3000
```

## 배포 설정

### Render.com
- Build Command: `cd backend && npm install && npm run build`
- Start Command: `cd backend && npm start`
- Environment: Node 20
- Health Check: `/api/health`
