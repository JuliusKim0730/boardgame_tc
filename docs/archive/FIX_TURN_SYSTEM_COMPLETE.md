# 턴 시스템 완전 수정

## 수정 날짜
2024-12-03

## 수정된 문제

### 1. ✅ Day 전환 및 선플레이어 변경
**문제**: Day 1 완료 후 Day 2로 넘어가지 않음, 선플레이어 변경 안 됨

**해결**:
- 모든 플레이어 턴 완료 시 다음 날로 전환
- 턴 순서 재배치: 이전 #2가 새 #1이 됨

```typescript
// 턴 순서 재배치
await client.query(
  `UPDATE player_states 
   SET turn_order = CASE 
     WHEN turn_order = 0 THEN $1 - 1
     ELSE turn_order - 1
   END
   WHERE game_id = $2`,
  [totalPlayers, gameId]
);
```

### 2. ✅ Day 8 결심 토큰 회복
**문제**: Day 8 시작 시 토큰 회복 안 됨

**해결**:
- Day 8 시작 시 1-7일차 동안 미사용 플레이어에게 토큰 1개 회복

```typescript
if (newDay === 8) {
  await client.query(
    `UPDATE player_states ps
     SET resolve_token = LEAST(resolve_token + 1, 2)
     WHERE game_id = $1
     AND NOT EXISTS (
       SELECT 1 FROM event_logs el
       WHERE el.event_type = 'resolve_token_used'
       AND el.data->>'playerId' = ps.player_id::text
     )`,
    [gameId]
  );
}
```

### 3. ✅ 수동 턴 종료
**문제**: 자동 턴 종료로 인해 결심 토큰 사용 불가

**해결**:
- 자동 턴 종료 제거
- 턴 종료 버튼 추가
- 결심 토큰 사용 힌트 표시

```typescript
// 행동 완료 후 자동 턴 종료 제거
setMessage('행동 완료! 턴을 종료하거나 결심 토큰을 사용하세요.');

// 턴 종료 버튼
<button onClick={handleEndTurn}>턴 종료</button>
```

### 4. ✅ AI 행동 완료 후 화면 업데이트
**문제**: AI 행동 완료 후 화면이 업데이트되지 않음

**해결**:
- WebSocket 이벤트로 상태 업데이트
- 턴 종료 후 자동 새로고침

## 게임 플로우

### Day 전환
```
Day 1:
  플레이어 #1 턴 → #2 턴 → #3 턴 (완료)
  ↓
Day 2:
  플레이어 #2 턴 (새 선플레이어) → #3 턴 → #1 턴
  ↓
Day 3:
  플레이어 #3 턴 (새 선플레이어) → #1 턴 → #2 턴
```

### 결심 토큰
```
Day 1-7: 토큰 1개 (초기)
  - 사용 시: 추가 행동 1회
  - 미사용 시: Day 8에 회복

Day 8: 토큰 회복 체크
  - 1-7일차 미사용: +1개 (최대 2개)
  - 사용함: 그대로 (0개)

Day 8-14: 토큰 사용 가능
```

### 턴 진행
```
1. 이동 (인접 칸)
2. 행동 (이동한 칸의 행동)
3. 턴 종료 선택:
   a. 턴 종료 버튼 클릭 → 다음 플레이어
   b. 결심 토큰 사용 → 추가 행동 (미구현)
```

### 14일차 종료
```
Day 14 마지막 플레이어 턴 종료
  ↓
게임 상태: 'finalizing'
  ↓
최종 구매 단계 (미구현)
  - 손패 카드 구매
  ↓
공동 계획 기여 (미구현)
  - 10,000TC 목표
  ↓
결과 화면
  - 점수 계산
  - 순위 표시
```

## 수정된 파일

### 백엔드
1. `backend/src/services/TurnManager.ts`
   - Day 전환 로직 수정
   - 선플레이어 변경 로직 추가
   - Day 8 토큰 회복 로직 추가

### 프론트엔드
1. `frontend/src/components/GameScreen.tsx`
   - 자동 턴 종료 제거
   - 수동 턴 종료 버튼 추가
   - handleEndTurn 함수 추가

2. `frontend/src/components/GameScreen.css`
   - 턴 종료 버튼 스타일 추가
   - 결심 토큰 힌트 스타일 추가

## 미구현 기능

### 1. 결심 토큰 사용
- UI: 결심 토큰 사용 버튼
- 로직: 추가 행동 1회 가능
- 제약: 직전 행동 칸 반복 불가

### 2. 최종 구매
- UI: 손패 카드 선택 모달
- 로직: 예산 내 카드 구매
- 효과: 특성 점수 적용

### 3. 공동 계획 기여
- UI: 기여 금액 입력 모달
- 로직: 10,000TC 목표 달성
- 보너스: 달성 시 +300점, 최다 기여자 +500점

### 4. 비주류 특성 변환
- UI: 변환 횟수 선택 모달
- 로직: 3점 → 추억 1점
- 제약: 가중치 1배 특성만

## 테스트 시나리오

### Day 전환 테스트
1. 3명 플레이어 게임 시작
2. Day 1 모든 플레이어 턴 완료
3. Day 2 시작 확인
4. 선플레이어 변경 확인 (이전 #2 → 새 #1)

### 결심 토큰 테스트
1. Day 1-7 동안 토큰 미사용
2. Day 8 시작 시 토큰 회복 확인 (1 → 2)
3. Day 8-14 동안 토큰 사용 가능 확인

### 턴 종료 테스트
1. 이동 → 행동 완료
2. 턴 종료 버튼 표시 확인
3. 결심 토큰 힌트 표시 확인
4. 턴 종료 버튼 클릭 → 다음 플레이어 확인

### 14일차 종료 테스트
1. Day 14 마지막 플레이어 턴 종료
2. 게임 상태 'finalizing' 확인
3. 최종 구매 화면 표시 (미구현)

## 로그 예시

### 정상 Day 전환
```
📅 Day 1 완료 → Day 2 시작
🔄 선플레이어 변경: 이전 #2 → 새 #1
🔒 턴 락 설정: gameId=xxx, playerId=yyy
```

### Day 8 토큰 회복
```
📅 Day 7 완료 → Day 8 시작
🔥 Day 8 시작 - 결심 토큰 회복 체크
✅ 플레이어 A: 토큰 1 → 2
✅ 플레이어 B: 토큰 0 (사용함)
```

### 14일차 종료
```
📅 Day 14 완료
🏁 14일차 완료 - 게임 종료
게임 상태: finalizing
```

## 다음 단계

### 우선순위 1 (필수)
1. 결심 토큰 사용 구현
2. 최종 구매 구현
3. 공동 계획 기여 구현
4. 비주류 특성 변환 구현

### 우선순위 2 (개선)
1. AI 결심 토큰 사용 전략
2. AI 최종 구매 전략
3. AI 공동 계획 기여 전략
4. AI 특성 변환 전략

### 우선순위 3 (선택)
1. 턴 타이머
2. 턴 히스토리
3. 행동 취소
4. 리플레이

## 참고 문서

- `TURN_SYSTEM_DEBUG.md` - 턴 시스템 디버깅
- `AI_TURN_FIX.md` - AI 턴 수정
- `GAME_FLOW_COMPLETE_FIX.md` - 게임 플로우 수정
