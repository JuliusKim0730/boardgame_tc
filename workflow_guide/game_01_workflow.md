## **🚀 '열네 밤의 꿈' 웹 보드게임 개발 워크플로우 (Ver. 2.0)**

### **🎯 1단계: 웹사이트 접속 및 로비 시스템 (Room Management)**

| 구분 | 기능 (UI/UX) | 백엔드/데이터베이스 처리 |
| :---- | :---- | :---- |
| **A. 방 접속/대기** | 방 만들기, 방 번호 입력, 대기실 화면 표시. | \- |
| **B. 플레이어 동기화** | 접속한 모든 플레이어 목록 실시간 표시. | **WebSocket** 연결을 통해 방 참여자 변경 사항을 모든 클라이언트에게 즉시간 푸시. |
| **C. 게임 시작** | 방장이 시작 버튼 클릭. | `GameRoom` 상태 → '진행 중'. **2단계 (게임 세팅)** 호출. |

Sheets로 내보내기

### **🎲 2단계: 게임 세팅 및 초기화 (Rule Setup)**

1단계 시작 버튼 클릭 시, 서버에서 룰북의 규칙을 기반으로 모든 게임 요소를 준비합니다.

| 룰북 단계 | 서버 처리 내용 | DB/메모리 저장 내용 |
| :---- | :---- | :---- |
| **카드 덱 준비** | **6종의 카드 덱** (계획, 집안일, 투자, 찬스, 공동 계획, 여행지)을 모두 셔플하고 순서를 확정. | 각 카드 덱의 순서, 카드별 **비용, 효과, 수익** 데이터를 메모리에 로드. |
| **여행지/공동 계획** | 여행지 카드 1장, 공동 계획 카드 1장 오픈. | **여행지 특성 배수** (메인 x3, 일반 x2, 서브 x1) 및 **공동 계획 목표 금액** 저장. |
| **플레이어 초기화** | 플레이어별 초기 자원 지급 (돈 2,000원, 위치 1번, 계획 카드 1장, 결심 토큰 1개). | 모든 플레이어의 초기 상태 DB 업데이트. **선플레이어** 결정 후 턴 순서 저장. |

Sheets로 내보내기

### **🎮 3단계: 게임 플레이 루프 (Turn & Card Action Implementation)**

게임은 총 14일(라운드) 동안 진행되며, **실시간 상호작용**이 핵심입니다.

#### **A. 턴 시작 및 동기화**

1. **턴 시작:** 현재 선플레이어에게 턴 시작 알림 (UI 활성화).  
2. **타인 관전:** **타 플레이어**에게는 'A님 턴입니다' 메시지와 함께 현재 게임판 및 플레이어 정보를 실시간으로 표시 (UI 비활성화).

#### **B. 플레이어 턴 (이동 → 행동)**

| 단계 | 프론트엔드 (UI/UX) | 백엔드 (로직 및 DB 처리) |
| :---- | :---- | :---- |
| **1\) 이동** | 연결된 칸 중 1곳 선택 (같은 칸 연속 사용 불가 규칙 적용). | 선택 칸의 **유효성 검사** 후 플레이어 위치 DB 업데이트. |
| **2\) 행동** | 도착한 칸에 따른 6가지 행동 선택 UI 활성화. (필요 시 **결심 토큰** 사용 옵션 제공). | **\[핵심\] 모든 카드 행동 구현** |
|  |  | \- **1\~4번 행동:** 해당 덱에서 카드 드로우 → 비용/수익/효과 즉시 적용 → DB 업데이트. |
|  |  | \- **5번 찬스 카드:** 드로우 후 **카드 효과별 전용 로직** 호출 (아래 상세 구현). |
|  |  | \- **6번 자유 행동:** 결심 토큰 소모 확인 후, 원하는 1\~5번 행동 로직 호출. |

Sheets로 내보내기

#### **C. 상세 카드 행동 구현 (Chance 카드 상호작용)**

특히 상호작용이 발생하는 찬스 카드(총 6장)는 서버에서 **특수 로직**을 통해 구현되어야 합니다.

| 찬스 카드 | 로직 처리 | 프론트엔드 알림 |
| :---- | :---- | :---- |
| **C8 (친구랑 같이 집안일)** | 대상 플레이어를 **강제 집안일** 칸으로 이동 처리 → 해당 플레이어에게 집안일 카드 드로우 요청 → 수익을 두 플레이어 모두에게 지급. | 'B님이 당신을 집안일 칸으로 보냈습니다. 카드 1장을 뽑아주세요.' |
| **C10 (계획 구매 요청)** | 대상 플레이어에게 손에 든 계획 카드 목록을 요청 → 대상 플레이어의 **'판매 승인/거절'** 응답을 기다림 → 승인 시, 1,000원을 지불하고 카드 소유권 이전. | 'B님이 1,000원에 카드를 구매 요청했습니다. 수락하시겠습니까?' |
| **C11 (계획 교환)** | 대상 플레이어와 서로 교환할 카드 선택을 요청 → 두 플레이어의 응답 확인 후 카드 소유권 맞교환. | 'B님과 교환할 카드를 선택해주세요.' |
| **C12, C13 (이동 조작)** | 대상 플레이어들의 위치 DB를 강제로 변경 → 위치 변경 결과를 모든 클라이언트에게 푸시. | 'A님의 행동으로 모두 \[새 위치\]로 이동되었습니다.' |

Sheets로 내보내기

#### **D. 일차 종료 및 공동 계획 기여**

* **일차 종료:** 모든 플레이어 행동 완료 후, 턴 순서 변경 (이전 2번째 플레이어가 선플레이어).  
* **공동 계획 기여:** 플레이어는 자신의 턴이나 비턴 시에도 **공동 계획 기여금**을 지불하는 액션을 수행할 수 있어야 합니다. (DB의 `JointPlanContribution` 필드 업데이트).

### **🏆 4단계: 최종 정산 및 방 유지 (End Game & Replay)**

14일차의 최종 행동(계획 카드 구매)이 끝나면 게임 종료 절차를 진행합니다.

| 단계 | 백엔드 처리 (데이터 계산) | 프론트엔드 (UI/UX) |
| :---- | :---- | :---- |
| **A. 최종 구매** | 14일차에 모든 플레이어가 **보유 돈**으로 손에 든 계획 카드를 구매 처리. | 플레이어에게 **'구매 완료'** 버튼을 누르도록 유도. |
| **B. 점수 계산** | 1\. **공동 계획** 성공/실패 여부 및 보상/패널티 적용. | \- |
|  | 2\. **최종 점수 합산** (특성 × 배수, 추억, 보상 등). | \- |
| **C. 결과 화면 표시 (New)** | 서버가 모든 플레이어에게 다음 정보를 포함한 **`GameResult`** 객체를 전송: 1\. **최종 점수** 및 순위. 2\. **점수 계산 상세 내역**. 3\. **최종 보유 돈**. 4\. **보유하고 구매한 모든 계획/무료 카드 목록**. | **모달 형태의 결과 창**을 띄워 상세 정보를 표시. (결과 창을 닫을 수 있는 '확인' 버튼 제공) |
| **D. 방 유지 및 재시작 (New)** | 모든 플레이어가 결과 창을 닫았다는 신호(클라이언트 → 서버)를 수신하면: | 결과 창 닫기 버튼 클릭. |
|  | 1\. \*\*`GameRoom`\*\*의 모든 게임 데이터(돈, 카드, 위치, 점수, 덱 순서)를 **초기화 (Soft Reset)**. | **대기방 화면**으로 자동 전환. |
|  | 2\. `GameRoom` 상태 → \*\*'대기' (Waiting)\*\*로 변경. | **'시작하기'** 버튼이 다시 활성화됨 (방장만). |
|  | 3\. 모든 클라이언트에게 '방이 재시작 준비 완료 상태가 되었습니다.' 알림 푸시. | 이전 멤버 그대로 새 게임을 바로 시작할 수 있습니다. |

## **5단계: 추가 상세 설계 및 예외 처리 (Advanced Workflow)**

### **1\. 동시성 및 비동기 처리 상세 설계**

| 항목 | 상세 설계 내용 | 예외 처리 및 방지책 |
| :---- | :---- | :---- |
| **A. 턴 잠금 (Turn Locking)** | 현재 턴 플레이어 외에는 모든 액션(이동, 행동 버튼 등)을 서버에서 **Reject** 처리. 프론트엔드에서는 UI를 비활성화(Disable) 처리. | **Latency/Double Click 방지:** 클라이언트가 이동/행동 요청을 보냈을 때, 서버는 응답을 주기 전까지 해당 플레이어의 다른 요청을 모두 무시(Ignore) 또는 대기열(Queue)에 넣습니다. |
| **B. 공동 계획 기여** | 기여는 플레이어의 턴이 아닐 때도 가능해야 합니다. 서버는 **기여 요청** 시 플레이어의 **보유 돈 $\\geq$ 기여 금액**을 확인하고 즉시 DB에 반영. | **동시 기여 충돌:** 여러 플레이어가 동시에 기여 요청 시, **데이터베이스 트랜잭션**을 사용하여 기여금 합산 및 돈 차감이 원자적(Atomic)으로 이루어지도록 보장해야 합니다. |
| **C. 찬스 카드 비동기** | **C10 (구매 요청), C11 (교환)** 등의 상호작용 카드 사용 시, 서버는 **'WAITING\_FOR\_RESPONSE'** 상태로 전환하고 타임아웃을 설정합니다. | **응답 타임아웃:** 대상 플레이어가 일정 시간(예: 30초) 내 응답이 없으면, 서버는 해당 상호작용을 **강제 거절(Decline)** 처리하고 턴을 진행시켜 게임 흐름이 멈추지 않도록 합니다. |

### **2\. 예외적인 게임 진행 로직 처리**

| 항목 | 상세 설계 내용 | 룰북 기반 고려 사항 |
| :---- | :---- | :---- |
| **D. 결심 토큰 사용** | 결심 토큰 사용 시에도 \*\*연속 행동 금지 규칙($2 \\to 2$ 불가)\*\*은 **무시할 수 없음**. | 결심 토큰 사용 요청 시, 서버는 현재 위치와 요청된 행동 칸을 확인하여 인접 칸 이동 여부만 체크하고, 연속 사용 금지 규칙을 반드시 적용해야 합니다. |
| **E. 찬스 카드 '모두 소환'** | **C12 (모두 내 자리로)** 사용 시, 카드 사용자를 포함하여 모든 플레이어의 위치를 강제로 변경. | 서버는 모든 플레이어의 위치를 업데이트하고, 해당 칸의 **행동이 유발되지 않음**을 명시해야 합니다. (이동만 발생) |
| **F. 공동 계획 실패 패널티** | 실패 시, \*\*가장 적게 낸 플레이어(들)\*\*에게만 추억 \-2 패널티 적용. 2인 플레이에서는 실패 패널티 없음. | 서버는 최종 정산 시, 2인 플레이 여부를 먼저 확인한 후 $\\rightarrow$ 3인 이상인 경우, 기여금 최저 금액을 계산하여 해당 플레이어(들)에게만 점수를 차감해야 합니다. |

### **3\. 접속 끊김 (Disconnect) 및 복구 처리**

| 항목 | 상세 설계 내용 | 예외 처리 및 방지책 |
| :---- | :---- | :---- |
| **G. 임시 접속 끊김** | 플레이어의 WebSocket 연결이 일시적으로 끊길 경우, 일정 시간(예: 5분) 동안 **'자리 비움 (AFK)'** 상태로 방에 유지합니다. | **자동 진행 (Bot Handoff):** AFK 시간이 초과되거나, 해당 플레이어의 턴이 되었는데 접속 복구가 안 될 경우, **자동 행동(Bot)** 로직을 사용하여 '가장 안전한 행동(예: 1번 무료 계획)'을 대신 수행하고 턴을 넘깁니다. |
| **H. 영구 이탈** | 플레이어가 게임 도중 방을 나갔거나 AFK 시간이 너무 길어지면, 해당 플레이어의 상태를 \*\*'이탈(Leaver)'\*\*로 변경. | **게임 지속:** 4인 게임 중 1명 이탈 시 3인 게임으로 지속. 2인 게임 중 1명 이탈 시 **게임 강제 종료** 또는 **승리 처리** (규칙 협의 필요). |

### **4\. Replay 및 방 유지 상세 처리 (Soft Reset)**

| 항목 | 상세 설계 내용 | 예외 처리 및 방지책 |
| :---- | :---- | :---- |
| **I. 결과 화면 동기화** | 모든 플레이어가 결과 창을 닫아야만 Soft Reset을 시작. 서버는 클라이언트로부터 **N개의 'Result Closed' 신호**를 받을 때까지 대기합니다. | **신호 누락 방지:** 만약 1명의 신호가 누락되어 무한 대기하는 경우, 방장이 **'강제 재시작'** 버튼을 누르거나, 일정 시간(예: 1분) 후 **자동 리셋**되도록 폴백(Fallback) 로직을 구현합니다. |
| **J. Soft Reset 범위** | 방에 참여한 플레이어 목록(ID)은 유지됩니다. | **재사용 금지:** 이전 게임에서 구매했던 **계획 카드**는 완전히 초기화되어 덱으로 돌아가 다시 셔플되어야 합니다. (이전 라운드 정보 완전 삭제) |

