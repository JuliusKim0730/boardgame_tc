# 5.00 동시성/예외/복구 (Advanced Workflow)

## 목적
- 동시 요청 충돌 방지, 상호작용 타임아웃, 접속 단절/AFK/이탈 처리, Soft Reset 안정화.

## 핵심 정책
- Turn Locking: 현재 턴 플레이어 외 액션 Reject/Queue.
- 상호작용(예: CH10/CH11/CH12/CH13): `WAITING_FOR_RESPONSE` + 타임아웃(30s) 강제 거절.
  - **2인 전용**: CH11/CH12/CH13 요청 차단, 해당 카드 뽑을 시 자동 스킵 또는 재추첨.
- 공동 계획 기여: DB 트랜잭션으로 누적/차감 원자성 보장.
- 결심 토큰 회복: 7일차 시작 시 1~6일차 미사용 플레이어 감지 및 토큰 지급.
- AFK: 5분 유지 후 Bot 대행 또는 정책에 따라 강제 종료/승계.
- Soft Reset: 결과 닫기 신호 N개 수신 또는 타이머 폴백.

## API/이벤트
- WS 에러 채널: `error.rate_limited`, `error.invalid_turn`, `timeout.interaction`
- 관리용(옵션): POST `/rooms/{roomId}/force-restart`

## 데이터/ERD 매핑
- `EVENTLOG`에 타임아웃/예외 기록.
- `PLAYERSTATE.status` AFK/LEFT/BOT 상태 전환.

## 테스트
- 정상: Lock이 중복 액션을 차단하고 순차 진행 보장.
- 경계: 상호작용 타임아웃 후 강제 거절 경로, 결심 토큰 7일차 회복 타이밍 정확성.
- **2인 전용**: CH11/CH12/CH13 차단 확인, 해당 카드 뽑을 시 처리 검증.
- 오류: AFK 초과 시 Bot 대행으로 게임 지속.

## MLOps 적용
- Job ID: `wf-5.00-advanced`
- 목적: 경쟁 조건 회귀 테스트, 타임아웃/AFK 시뮬레이션.
- GitHub Actions 스니펫:
```yaml
name: wf-5.00-advanced
on:
  workflow_dispatch:
jobs:
  race-sim:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - run: npm run test:races -- --seed=42
```





