# 3.00 턴 루프/카드 행동 (Turn & Card Action)

## 목적
- 14일 동안 선플레이어 알림 → 이동 → 행동(1~6) → 상태 동기화를 안전하게 수행.

## 입력/출력
- 입력: 현재 턴 플레이어의 이동/행동 요청, 비턴의 공동 계획 기여.
- 출력: 상태 업데이트 브로드캐스트, 찬스 상호작용 요청/응답.

## 상태 기계(개요)
- `TURN.started` → 이동(valid) → 행동(1~6) → `TURN.ended` → 다음 플레이어
- **14일차**: 모든 플레이어가 "이동 → 행동" 필수 수행 후 최종 결산 진입.

## 이동 제약
- 인접 칸으로만 이동, 직전 턴에 행동한 칸으로 자발적 이동 불가.
- 결심 토큰 사용 시에도 직전 행동 칸 반복 불가 규칙 유효.
- **예외**: 찬스 카드 등으로 강제 이동 시 "직전 턴 행동 칸 불가" 규칙 미적용.
- **결심 토큰**: 기본 최대 2개, 1~6일차 미사용 시 7일차 시작 시 1개 회복.

## 행동(1~6)
- 1 무료 계획: 무료계획 카드 1장 획득(Hand 추가).
- 2 조사하기: 계획 카드 1 드로우.
- 3 집안일: 집안일 1 드로우, 수익 반영(1,500~2,000TC). **2인 전용**: 첫 방문 시 +500TC 추가.
- 4 여행 지원: 여행 지원 카드 1 드로우, TC 변동 반영(수익 Y1~Y8, 지출 Y9~Y16).
- 5 찬스: 특수 로직(CH1~CH25). **2인 전용**: 찬스 카드 OR 500TC 선택 가능.
- 6 자유 행동: 원하는 1~5 중 1회 실행(6 연속 금지).

## 찬스 상호작용
- 대상 응답 대기 상태 `WAITING_FOR_RESPONSE` + 타임아웃(예: 30s).
- 무응답 시 강제 거절 후 턴 진행.
- **신규 카드**: CH19 "반전의 기회" - 이동 없이 현재 칸 행동 1회 추가.
- **2인 전용 금지**: CH11(계획 교환), CH12(모두 내 자리로), CH13(자리 바꾸기) 처리 차단.

## API/이벤트
- POST `/games/{gameId}/move`
- POST `/games/{gameId}/action`
- POST `/games/{gameId}/chance/{code}`
- WS 이벤트: `turn.started`, `state.updated`, `chance.request`, `chance.resolved`

## 데이터/ERD 매핑
- 이동: `PLAYERSTATE.position`
- 드로우/핸드: `DECK.order`, `HAND`
- 자원/특성: `PLAYERSTATE.money/traits`
- 상호작용 로그: `EVENTLOG`

## 동시성
- Turn Lock: 현재 턴 플레이어 이외 요청은 Reject/Queue.
- 공동 계획 기여는 트랜잭션으로 누적/차감 원자성 보장.

## 복잡도
- 드로우 O(1), 이동/검증 O(1), 점수 합산/방송 O(players).

## 테스트
- 정상: 이동→행동→브로드캐스트 일관성, 집안일 수익 1,500~2,000TC 확인.
- 경계: 동일 프레임 이중 클릭, 2개 요청 중 1개만 처리, 결심 토큰 7일차 회복 확인.
- 오류: 상호작용 타임아웃 강제 거절 후 진행 유지.
- **2인 전용**: 찬스 칸 500TC 선택, 집안일 첫 방문 +500TC, CH11/12/13 차단 확인.
- **14일차**: 모든 플레이어 필수 행동 수행 후 정산 진입 확인.

## MLOps 적용
- Job ID: `wf-3.00-turn`
- 목적: 턴/액션 서비스 통합 시뮬레이션, WS 부하 테스트.
- GitHub Actions 스니펫:
```yaml
name: wf-3.00-turn
on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"
jobs:
  sim-turn-ws:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - run: npm run test:ws-sim -- --duration=5m
```





