# 4.00 최종 정산/리플레이 (End Game & Replay)

## 목적
- 14일차 종료 후 최종 구매/공동 목표 판정/비주류 특성 변환/점수 계산/결과 표시 및 방 유지 소프트 리셋.

## 입력/출력
- 입력: 최종 구매 요청, 결과 창 닫기 신호(N명).
- 출력: `GameResult`(점수/순위/세부내역), 소프트 리셋 완료 이벤트.

## 처리
- 최종 구매: 보유 돈으로 Hand의 계획 구매 → `PURCHASED` 기록.
- 공동 목표 판정: 기여 금액 동시 공개 및 성공/실패 판정.
  - **성공**: 보너스 효과 획득.
  - **실패**: 3~5인 플레이 시 최저 기여자 추억 -2. **2인 플레이 시 패널티 없음**.
- 비주류 특성 변환 (선택):
  - 여행지 가중치 1배인 비주류 특성 3점 → 추억 +1 변환.
  - 원하는 만큼 반복 가능, 게임 종료 후 한 번만 수행.
- 점수 계산:
  - 특성 점수: 여행지 배수 적용(가중치 3배/2배/1배)
  - 추억 점수 합산
  - 공동 목표 보너스
  - 최종 행복 점수 = (특성 점수 × 여행지 가중치) + 추억 점수 + 공동 목표 보너스
- 승리 판정 및 동률 규정:
  - 1순위: 최종 행복 점수 높은 플레이어
  - 동률 시 1순위: 추억 점수 높은 플레이어
  - 동률 시 2순위: 남은 TC 많은 플레이어
  - 최종: 공동 우승
- 결과 전송: 모든 플레이어에게 결과/순위/내역 브로드캐스트.
- 결과 창 동기화: N개의 닫기 신호 수신 후 소프트 리셋 시작.
- 소프트 리셋: `GameRoom` 유지, 게임 데이터 초기화 → 대기 상태 복귀.

## API/이벤트
- POST `/games/{gameId}/finalize`
- WS: `result.ready`, `result.closed`, `room.soft_reset.completed`

## 데이터/ERD 매핑
- `PURCHASED`, `GAMERESULT`, `EVENTLOG`

## 예외/폴백
- 결과 닫기 신호 누락 시: 방장 강제 재시작 버튼 또는 1분 타이머로 자동 리셋.

## 테스트
- 정상: 결과 생성 정확성(샘플 데이터와 일치), 소프트 리셋 후 재시작 가능.
- 경계: 공동 계획 실패 시 최저 기여자만 추억 -2(3인 이상), 2인 예외 확인.
- **비주류 특성 변환**: 가중치 1배 특성 3점 → 추억 +1 변환 정확성.
- **동률 규정**: 추억 점수 → TC 순서로 판정 확인.
- 오류: 일부 신호 누락 시 폴백 동작 확인.

## MLOps 적용
- Job ID: `wf-4.00-finalize`
- 목적: 점수 산출 스냅샷 테스트, 리플레이/리셋 회귀 테스트.
- GitHub Actions 스니펫:
```yaml
name: wf-4.00-finalize
on: [push]
jobs:
  score-regression:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - run: npm run test:score -- --golden
```





